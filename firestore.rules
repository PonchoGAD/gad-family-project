rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ======================
       HELPERS
    ====================== */
    function userFamilyId(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.familyId;
    }

    function isOwnerOfFamily(requesterUid, fid) {
      return get(/databases/$(database)/documents/families/$(fid)).data.ownerUid == requesterUid;
    }

    function isAdultInFamily(requesterUid, fid) {
      return get(/databases/$(database)/documents/families/$(fid)/members/$(requesterUid)).data.isAdult == true;
    }

    function canSeeSubjectInFamily(requesterUid, subjectUid) {
      let fid = userFamilyId(subjectUid);
      return requesterUid == subjectUid
        || isOwnerOfFamily(requesterUid, fid)
        || isAdultInFamily(requesterUid, fid);
    }

    /* ======================
       USERS
    ====================== */
    match /users/{uid} {
      // Базовое правило: владелец может читать/писать свой документ
      allow read, write: if request.auth != null && request.auth.uid == uid;

      match /assistant/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
      match /todos/{tid} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
      match /calendar/{eid} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      match /nftOwnerships/{id} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }
      match /swapOrders/{id} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }
      match /lpOrders/{id} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }
      match /stakingPositions/{id} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }
      match /portfolioLedger/{id} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }

      // Бейджи: видны только пользователю, но создаются/обновляются только через backend (Cloud Functions)
      match /badges/{badgeId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }
    }

    /* ======================
       PRIVATE ASSISTANT MESSAGES
    ====================== */
    match /messages_private/{uid}/assistant/{mid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    /* ======================
       FAMILIES ROOT
    ====================== */
    match /families/{fid} {
      // Семейный документ может читать любой авторизованный (для FindFriends и т.д.)
      allow read: if request.auth != null;
      allow write: if false;

      match /members/{uid} {
        allow read: if request.auth != null && (
          request.auth.uid == uid ||
          isOwnerOfFamily(request.auth.uid, fid) ||
          isAdultInFamily(request.auth.uid, fid)
        );
        allow write: if false;
      }

      match /approvals/{aid} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /places/{pid} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /geoEvents/{eid} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /geoState/{uid} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }

      match /elections/{eid} {
        allow read: if request.auth != null;
        allow write: if false;

        match /votes/{voterUid} {
          allow read: if request.auth != null;
          allow write: if false;
        }
      }

      /* ----- FAMILY VAULT & LEDGER (СТАРЫЕ ПРАВИЛА) ----- */
      match /vault {
        allow read: if request.auth != null &&
          (isOwnerOfFamily(request.auth.uid, fid) || isAdultInFamily(request.auth.uid, fid));
        allow write: if false;
      }

      match /vaultMembers/{uid} {
        allow read: if request.auth != null && (
          request.auth.uid == uid ||
          isOwnerOfFamily(request.auth.uid, fid) ||
          isAdultInFamily(request.auth.uid, fid)
        );
        allow write: if false;
      }

      match /vaultIncomes/{iid} {
        allow read: if request.auth != null &&
          (isOwnerOfFamily(request.auth.uid, fid) || isAdultInFamily(request.auth.uid, fid));
        allow write: if false;
      }

      match /vaultDistributions/{did} {
        allow read: if request.auth != null &&
          (isOwnerOfFamily(request.auth.uid, fid) || isAdultInFamily(request.auth.uid, fid));
        allow write: if false;
      }

      match /ledger/{entryId} {
        allow read: if request.auth != null &&
          (isOwnerOfFamily(request.auth.uid, fid) || isAdultInFamily(request.auth.uid, fid));
        allow write: if false;
      }

      /* ----- FAMILY VAULT (НОВАЯ СТРУКТУРА: vault/main + locked) ----- */
      // families/{fid}/vault/main
      match /vault/{docId} {
        allow read: if request.auth != null &&
          (isOwnerOfFamily(request.auth.uid, fid) || isAdultInFamily(request.auth.uid, fid));
        allow write: if false;

        // families/{fid}/vault/main/locked/{uid}
        match /locked/{uid} {
          allow read: if request.auth != null && (
            request.auth.uid == uid ||
            isOwnerOfFamily(request.auth.uid, fid) ||
            isAdultInFamily(request.auth.uid, fid)
          );
          allow write: if false;
        }
      }

      /* ----- FAMILY CHATS (multi-family) ----- */
      match /chats/{chatId} {
        // читать / писать чат может только пользователь, у которого familyId == fid
        allow read: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
        allow write: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;

        match /messages/{mid} {
          allow read: if request.auth != null &&
            userFamilyId(request.auth.uid) == fid;
          allow write: if request.auth != null &&
            userFamilyId(request.auth.uid) == fid;
        }
      }

      /* ----- FAMILY TODO LIST (tasks) ----- */
      match /tasks/{tid} {
        // задачи семьи доступны всем членам семьи
        allow read: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
        allow write: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
      }

      /* ----- FAMILY GOALS ----- */
      match /goals/{goalId} {
        // цели семьи доступны всем членам семьи
        allow read: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
        allow write: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
      }

      /* ----- FRIEND REQUESTS ----- */
      match /friendRequests/{reqId} {
        // читать могут все авторизованные (для публичного слоя дружб / отладки)
        allow read: if request.auth != null;
        // писать может только семья, соответствующая fid
        allow write: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
      }

      /* ----- FRIENDS LIST ----- */
      match /friends/{otherFamilyId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null &&
          userFamilyId(request.auth.uid) == fid;
      }
    }

    /* ======================
       LOCATIONS
    ====================== */
    match /locations/{kind} {
      allow read: if request.auth != null;
      allow write: if false;

      match /{uid}/{docId} {
        allow read: if request.auth != null && canSeeSubjectInFamily(request.auth.uid, uid);
        allow write: if false;
      }
    }

    /* ======================
       TOP LEVEL
    ====================== */
    match /earnings/{uid}/{date} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // ❗ FIX: новая структура шагов: dailySteps/{uid}/days/{date}
    match /dailySteps/{uid}/days/{date} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /redemptions/{uid}/{rid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /suggestions/{fid}/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    match /funds/{fundId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    /* ----- REFERRALS (для ReferralScreen) ----- */
    match /referrals/{uid}/items/{itemId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    /* ----- REWARDS (для step-engine и RewardsScreen) ----- */
    // rewards/{uid} + rewards/{uid}/days/{date}
    match /rewards/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;

      match /days/{date} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }
    }

    /* ----- GAS STIPEND (для GasHistoryScreen и applyGasStipend) ----- */
    match /gasStipend/{uid}/items/{itemId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false; // пополняем только через Cloud Functions
    }
  }
}
