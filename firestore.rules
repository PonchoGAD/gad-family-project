rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /** ===== helpers ===== */
    function userFamilyId(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.familyId;
    }
    function isOwnerOfFamily(requesterUid, fid) {
      return get(/databases/$(database)/documents/families/$(fid)).data.ownerUid == requesterUid;
    }
    function isAdultInFamily(requesterUid, fid) {
      return get(/databases/$(database)/documents/families/$(fid)/members/$(requesterUid)).data.isAdult == true;
    }
    function canSeeSubjectInFamily(requesterUid, subjectUid) {
      let fid = userFamilyId(subjectUid);
      return requesterUid == subjectUid
        || isOwnerOfFamily(requesterUid, fid)
        || isAdultInFamily(requesterUid, fid);
    }

    /** ===== users ===== */
    match /users/{uid} {
      // профиль пользователя
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // портфель (только чтение пользователем)
      match /nftOwnerships/{id}    { allow read: if request.auth != null && request.auth.uid == uid; allow write: if false; }
      match /swapOrders/{id}       { allow read: if request.auth != null && request.auth.uid == uid; allow write: if false; }
      match /lpOrders/{id}         { allow read: if request.auth != null && request.auth.uid == uid; allow write: if false; }
      match /stakingPositions/{id} { allow read: if request.auth != null && request.auth.uid == uid; allow write: if false; }
      match /portfolioLedger/{id}  { allow read: if request.auth != null && request.auth.uid == uid; allow write: if false; }

      // персональные ассистенты / ToDo / Calendar
      match /assistant/{docId} { allow read, write: if request.auth != null && request.auth.uid == uid; }
      match /todos/{tid}       { allow read, write: if request.auth != null && request.auth.uid == uid; }
      match /calendar/{eid}    { allow read, write: if request.auth != null && request.auth.uid == uid; }
    }

    /** приватные сообщения ассистента */
    match /messages_private/{uid}/assistant/{mid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    /** ===== families ===== */
    match /families/{fid} {
      allow read: if request.auth != null;
      allow write: if false;

      match /approvals/{aid} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /members/{uid} {
        allow read: if request.auth != null && (
          request.auth.uid == uid ||
          isOwnerOfFamily(request.auth.uid, fid) ||
          isAdultInFamily(request.auth.uid, fid)
        );
        allow write: if false;
      }

      match /places/{placeId} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /geoEvents/{eventId} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /geoState/{uid} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }

      match /elections/{eid} {
        allow read: if request.auth != null;
        allow write: if false;

        match /votes/{voterUid} {
          allow read: if request.auth != null;
          allow write: if false;
        }
      }

      match /distributions/{did} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /ledger/{entryId} {
        allow read: if request.auth != null && isOwnerOfFamily(request.auth.uid, fid);
        allow write: if false;
      }

      // FamilyVault блоки
      match /vault {
        allow read: if request.auth != null;
        allow write: if false;
      }
      match /vaultMembers/{uid} {
        allow read: if request.auth != null;
        allow write: if false;
      }
      match /vaultIncomes/{iid} {
        allow read: if request.auth != null;
        allow write: if false;
      }
      match /vaultDistributions/{did} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }

    /** ===== locations ===== */
    match /locations/{kind} {
      allow read: if request.auth != null;
      allow write: if false;

      match /{uid}/{docId} {
        allow read: if request.auth != null && canSeeSubjectInFamily(request.auth.uid, uid);
        allow write: if false;
      }
    }

    /** ===== misc top-level ===== */
    match /earnings/{uid}/{date} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /dailySteps/{uid}/{date} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /redemptions/{uid}/{rid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }
    match /suggestions/{fid}/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}

// Family calendar
match /calendar/{eid} {
  allow read: if request.auth != null;
  allow write: if false; // создание/обновление — через Cloud Functions
  match /comments/{cid} {
    allow read: if request.auth != null;
    allow write: if false;
  }
}

// Family chats
match /chats/{chatId} {
  allow read: if request.auth != null;
  allow write: if false;
  match /messages/{mid} {
    allow read: if request.auth != null;
    allow write: if false;
  }
}

// Family todos
match /todos/{tid} {
  allow read: if request.auth != null;
  allow write: if false;
}

// Family funds
match /funds/{fundId} {
  allow read: if request.auth != null;
  allow write: if false;
}
