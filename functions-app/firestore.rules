rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function userFamilyId(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.familyId;
    }

    function isOwnerOfFamily(requesterUid, fid) {
      return get(/databases/$(database)/documents/families/$(fid)).data.ownerUid == requesterUid;
    }

    function isAdultInFamily(requesterUid, fid) {
      return get(/databases/$(database)/documents/families/$(fid)/members/$(requesterUid)).data.isAdult == true;
    }

    function canSeeSubjectInFamily(requesterUid, subjectUid) {
      let fid = userFamilyId(subjectUid);
      return requesterUid == subjectUid
        || isOwnerOfFamily(requesterUid, fid)
        || isAdultInFamily(requesterUid, fid);
    }

    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /families/{fid} {
      allow read: if request.auth != null;
      allow write: if false;

      match /members/{uid} {
        allow read: if request.auth != null && (
          request.auth.uid == uid ||
          isOwnerOfFamily(request.auth.uid, fid) ||
          isAdultInFamily(request.auth.uid, fid)
        );
        allow write: if false;
      }

      match /places/{placeId} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /geoEvents/{eventId} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /geoState/{uid} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false;
      }

      match /elections/{eid} {
        allow read: if request.auth != null;
        allow write: if false;

        match /votes/{voterUid} {
          allow read: if request.auth != null;
          allow write: if false;
        }
      }

      match /distributions/{did} {
        allow read: if request.auth != null;
        allow write: if false;
      }

      match /ledger/{entryId} {
        allow read: if request.auth != null && isOwnerOfFamily(request.auth.uid, fid);
        allow write: if false;
      }
    }

    match /locations/{kind} {
      allow read: if request.auth != null;
      allow write: if false;

      match /{uid}/{docId} {
        allow read: if request.auth != null && canSeeSubjectInFamily(request.auth.uid, uid);
        allow write: if false;
      }
    }

    match /earnings/{uid}/{date} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /dailySteps/{uid}/{date} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /redemptions/{uid}/{rid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /suggestions/{fid}/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}
