import * as admin from "firebase-admin";
import { onCall, HttpsError } from "firebase-functions/v2/https";
import { onSchedule } from "firebase-functions/v2/scheduler";
import { onDocumentCreated } from "firebase-functions/v2/firestore";
import { defineSecret } from "firebase-functions/params";
import { ethers } from "ethers";
import { US_REGIONS, PUBLIC_TREASURY_CONFIG, TreasuryPublic } from "./config";

admin.initializeApp();

/** Secrets */
const BSC_RPC_URL        = defineSecret("BSC_RPC_URL");
const PAYOUT_PK          = defineSecret("PAYOUT_PK");
const GAD_TOKEN_ADDRESS  = defineSecret("GAD_TOKEN_ADDRESS");
const DISTRIBUTION_SAFE  = defineSecret("DISTRIBUTION_SAFE");
const TOKEN_DECIMALS     = defineSecret("TOKEN_DECIMALS");

/** Minimal ERC20 ABI */
const ERC20_ABI = [
  "function decimals() view returns (uint8)",
  "function transfer(address to, uint256 amount) returns (bool)",
  "function transferFrom(address from, address to, uint256 amount) returns (bool)"
];

/** Helpers */
;


/** 1) Public config */
export const getTreasuryPublic = onCall<TreasuryPublic>({ region: US_REGIONS }, async () => {
  return PUBLIC_TREASURY_CONFIG;
});

/\*\*\ 2\)\ Р В Р’В Р Р†Р вЂљРЎСљР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ°\ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р РЋРІР‚СљР В Р’В Р РЋРІР‚вЂќР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ\ Р В Р’В Р В РІР‚В \ Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РЎвЂњР В Р Р‹Р В РЎвЂњР В Р Р‹Р РЋРІР‚Сљ\ \*/\nexport\ const\ addIncome\ =\ onCall\(\{\ region:\ US_REGIONS,\ enforceAppCheck:\ true\ },\ async\ \(req\)\ =>\ \{\n\ \ const\ actor\ =\ req\.auth\?\.uid;\n\ \ if\ \(!actor\)\ throw\ new\ HttpsError\("unauthenticated","Auth\ required"\);\n\n\ \ const\ \{\ amount,\ currency,\ source,\ fromUid,\ meta\ }\ =\ req\.data\ as\ \{\n\ \ \ \ amount:\ number;\n\ \ \ \ currency:\ Currency;\n\ \ \ \ source:\ "steps"\|"bonus"\|"manual"\|"other";\n\ \ \ \ fromUid\?:\ string;\n\ \ \ \ meta\?:\ any;\n\ \ };\n\n\ \ if\ \(typeof\ amount\ !==\ "number"\ \|\|\ amount\ <=\ 0\)\ throw\ new\ HttpsError\("invalid-argument","amount\ >\ 0\ required"\);\n\ \ if\ \(!isCurrency\(currency\)\)\ throw\ new\ HttpsError\("invalid-argument","invalid\ currency"\);\n\n\ \ //\ Р В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋРІР‚СњР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ў\ Р В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’ВР В Р Р‹Р В Р вЂ°Р В Р’В Р РЋРІР‚В\n\ \ const\ \{\ db,\ fid,\ famRef\ }\ =\ await\ getFamilyContext\(actor\);\n\ \ await\ ensureVaultDoc\(famRef\);\n\n\ \ const\ contributorUid\ =\ fromUid\ \?\?\ actor;\n\n\ \ //\ Р В Р’В Р РЋРІР‚вЂњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚ВР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В\ Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РІР‚С™Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚СњР В Р Р‹Р РЋРІР‚Сљ\ Р В Р Р‹Р РЋРІР‚СљР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°\ Р В Р’В Р В РІР‚В \ vaultMembers\n\ \ await\ touchVaultMember\(famRef,\ contributorUid\);\n\n\ \ //\ Р В Р’В Р вЂ™Р’В·Р В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р Р‹Р В Р вЂ°\ Р В Р’В Р РЋРІР‚Сћ\ Р В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљР’В¦Р В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’Вµ\n\ \ const\ incRef\ =\ famRef\.collection\("vaultIncomes"\)\.doc\(\);\n\ \ const\ now\ =\ admin\.firestore\.FieldValue\.serverTimestamp\(\);\n\ \ await\ incRef\.set\(\{\n\ \ \ \ amount,\ currency,\ source,\ fromUid:\ contributorUid,\ meta:\ meta\ \?\?\ null,\ at:\ now\n\ \ }\);\n\n\ \ //\ Р В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р РЋРІР‚вЂњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р Р†Р вЂљРІвЂћвЂ“:\ balances\ \+\ Р В Р’В Р В РІР‚В Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В°Р В Р’В Р СћРІР‚В\ Р В Р Р‹Р РЋРІР‚СљР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°\n\ \ const\ batch\ =\ db\.batch\(\);\n\ \ const\ vRef\ =\ famRef\.collection\(""\)\.doc\("vault"\);\n\ \ batch\.set\(vRef,\ \{\n\ \ \ \ balances:\ \{\ \[currency]:\ admin\.firestore\.FieldValue\.increment\(amount\)\ },\n\ \ \ \ updatedAt:\ now\n\ \ },\ \{\ merge:\ true\ }\);\n\n\ \ const\ vmRef\ =\ famRef\.collection\("vaultMembers"\)\.doc\(contributorUid\);\n\ \ batch\.set\(vmRef,\ \{\n\ \ \ \ contributed:\ \{\ \[currency]:\ admin\.firestore\.FieldValue\.increment\(amount\)\ },\n\ \ \ \ updatedAt:\ now\n\ \ },\ \{\ merge:\ true\ }\);\n\n\ \ await\ batch\.commit\(\);\n\n\ \ await\ writeVaultLedger\(db,\ fid,\ actor,\ "addIncome",\ \{\ amount,\ currency,\ source,\ fromUid:\ contributorUid\ }\);\n\n\ \ //\ Р В Р’В Р В РІвЂљВ¬Р В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’ВµР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р РЋР’ВР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ\ Р В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В°Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р Р‹Р Р†Р вЂљР’В Р В Р Р‹Р РЋРІР‚Сљ\n\ \ try\ \{\n\ \ \ \ const\ ownerUid\ =\ \(await\ famRef\.get\(\)\)\.data\(\)\?\.ownerUid\ as\ string\ \|\ undefined;\n\ \ \ \ if\ \(ownerUid\)\ \{\n\ \ \ \ \ \ const\ ownerUser\ =\ await\ db\.collection\("users"\)\.doc\(ownerUid\)\.get\(\);\n\ \ \ \ \ \ const\ tokens:\ string\[]\ =\ ownerUser\.data\(\)\?\.fcmTokens\ \?\?\ ownerUser\.data\(\)\?\.expoTokens\ \?\?\ \[];\n\ \ \ \ \ \ if\ \(tokens\.length\)\ \{\n\ \ \ \ \ \ \ \ await\ admin\.messaging\(\)\.sendEachForMulticast\(\{\n\ \ \ \ \ \ \ \ \ \ tokens,\n\ \ \ \ \ \ \ \ \ \ notification:\ \{\ title:\ "Р В Р’В Р РЋРЎСџР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р РЋРІР‚СљР В Р’В Р РЋРІР‚вЂќР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ\ Р В Р’В Р В РІР‚В \ Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РЎвЂњР В Р Р‹Р В РЎвЂњР В Р Р‹Р РЋРІР‚Сљ",\ body:\ \$"\+\{amount}\ \{currency}"\ },\n\ \ \ \ \ \ \ \ \ \ data:\ \{\ kind:\ "vault_income",\ amount:\ String\(amount\),\ currency\ }\n\ \ \ \ \ \ \ \ }\);\n\ \ \ \ \ \ }\n\ \ \ \ }\n\ \ }\ catch\ \{}\n\n\ \ return\ \{\ ok:\ true,\ incomeId:\ incRef\.id\ };\n}\);\n/\*\*\ 3\)\ Р В Р’В Р РЋРЎвЂєР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚вЂњР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™:\ Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚Сћ-Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚вЂќР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ\ 80/20\ \(Р В Р’В Р РЋРІР‚В\ Р В Р Р‹Р Р†Р вЂљРЎвЂєР В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦Р В Р’В Р СћРІР‚ВР В Р Р‹Р Р†Р вЂљРІвЂћвЂ“\)\ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’Вµ\ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р РЋРІР‚СљР В Р’В Р РЋРІР‚вЂќР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ\ \*//** 3) Steps Р В Р’В Р В РІР‚В  points (MVP) */
export const submitDailySteps = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated", "Auth required");
  const { date, steps, source } = req.data as { date: string; steps: number; source: "device"|"healthkit"|"googlefit" };
  if (!date || typeof steps !== "number") throw new HttpsError("invalid-argument", "date/steps required");

  const db = admin.firestore();
  const user = (await db.collection("users").doc(uid).get()).data();
  if (!user?.familyId) throw new HttpsError("failed-precondition", "Join family first");

  const stepToPoint = 1000, dailyCap = 10000;
  const points = Math.min(Math.floor(steps / stepToPoint), dailyCap);

  await db.collection("dailySteps").doc(uid).collection("").doc(date).set({
    steps, source, verified: source !== "device", updatedAt: admin.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  await db.collection("earnings").doc(uid).collection("").doc(date).set({
    steps, pointsAwarded: points, reason: "daily", createdAt: admin.firestore.FieldValue.serverTimestamp()
  });

  return { ok: true, points };
});

/** 4) Payout request (pointsР В Р’В Р В РІР‚В GAD) */
export const requestPayout = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  const { points, toAddress } = req.data as { points: number; toAddress: string };
  if (!uid) throw new HttpsError("unauthenticated", "Auth required");
  if (!points || !toAddress) throw new HttpsError("invalid-argument", "points/toAddress required");

  const db = admin.firestore();
  const rid = db.collection("redemptions").doc(uid).collection("").doc().id;
  await db.collection("redemptions").doc(uid).collection("").doc(rid).set({
    status: "pending",
    points,
    toAddress: toAddress.toLowerCase(),
    createdAt: admin.firestore.FieldValue.serverTimestamp()
  });
  return { ok: true, rid };
});

///** 5) Weekly payout (needs Cloud Scheduler / Blaze; region us-east1) */
export const weeklyPayout = onSchedule({
  region: "us-east1",
  schedule: "0 22 * * 5",
  secrets: [BSC_RPC_URL, PAYOUT_PK, GAD_TOKEN_ADDRESS, DISTRIBUTION_SAFE, TOKEN_DECIMALS]
}, async () => {
  const provider = new ethers.JsonRpcProvider(BSC_RPC_URL.value());
  const signer = new ethers.Wallet(PAYOUT_PK.value(), provider);
  const token = new ethers.Contract(GAD_TOKEN_ADDRESS.value(), ERC20_ABI, signer);

  const decimals = Number(TOKEN_DECIMALS.value() || PUBLIC_TREASURY_CONFIG.DECIMALS);
  const from = DISTRIBUTION_SAFE.value();

  const db = admin.firestore();
  const q = await db.collectionGroup("redemptions").where("status", "==", "pending").get();
  if (q.empty) return;

  for (const doc of q.docs) {
    const d = doc.data() as any;
    try {
      const gad = d.points * 1e-6; // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ў Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В
      const amount = ethers.parseUnits(String(gad), decimals);
      const tx = await token.transferFrom(from, d.toAddress, amount);
      await tx.wait();
      await doc.ref.update({ status: "paid", txHash: tx.hash, paidAt: admin.firestore.FieldValue.serverTimestamp() });
    } catch (e) {
      await doc.ref.update({ status: "rejected", error: String(e) });
    }
  }
});//

/** 6) Calldata approve(spender, amount) */
export const buildApproveCalldata = onCall({ region: US_REGIONS }, async (req: any) => {
  const { spender, amountRaw, decimals } = req.data as { spender: string; amountRaw: string; decimals?: number };
  if (!spender || !amountRaw) throw new HttpsError("invalid-argument", "spender/amountRaw required");
  const d = decimals ?? PUBLIC_TREASURY_CONFIG.DECIMALS;
  const iface = new ethers.Interface(["function approve(address spender, uint256 amount)"]);
  const data = iface.encodeFunctionData("approve", [spender, ethers.parseUnits(amountRaw, d)]);
  return { to: PUBLIC_TREASURY_CONFIG.TOKEN_ADDRESS, value: "0", data, operation: 0 };
});

/** 7) Parent suggestions trigger */
export const onChildMessage = onDocumentCreated(
  { region: "us-east4", document: "messages/{fid}/{thread}/{mid}" },
  async (event) => {
    const msg = event.data?.data();
    if (!msg || msg.visibility !== "child_private" || msg.role !== "user") return;

    const db = admin.firestore();
    const family = (await db.collection("families").doc(event.params.fid).get()).data();
    const parentUid = family?.ownerUid;
    if (!parentUid) return;

    const text = [
      "1) Р В Р’В Р вЂ™Р’В Р В Р’В Р В РІР‚в„–Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В , Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°, Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В .",
      "2) Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРІвЂћвЂ“ Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРІвЂћвЂ“ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™ Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В .",
      "3) Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†РІР‚С™Р’В¬Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В , Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ°Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В ."
    ].join(" ");

    await db.collection("suggestions").doc(event.params.fid).collection("").add({
      toUid: parentUid,
      aboutUid: msg.fromUid,
      text,
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      status: "new"
    });
  }
);

// helpers
function computeAge(dobISO: string) {
  const dob = new Date(dobISO + "T00:00:00Z");
  const today = new Date();
  const years = today.getUTCFullYear() - dob.getUTCFullYear();
  const m = today.getUTCMonth() - dob.getUTCMonth();
  const d = today.getUTCDate() - dob.getUTCDate();
  return years - (m < 0 || (m === 0 && d < 0) ? 1 : 0);
}
function haversineM(a: {lat:number,lng:number}, b:{lat:number,lng:number}) {
  const R = 6371000;
  const toRad = (x:number)=>x*Math.PI/180;
  const dLat = toRad(b.lat-a.lat);
  const dLng = toRad(b.lng-a.lng);
  const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
async function familyOf(uid: string) {
  const db = admin.firestore();
  const u = await db.collection("users").doc(uid).get();
  const data = u.data();
  return data?.familyId as string | undefined;
}

export const registerBirthdate = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { dob } = req.data as { dob: string }; // YYYY-MM-DD
  if (!dob || !/^\d{4}-\d{2}-\d{2}$/.test(dob)) throw new HttpsError("invalid-argument","dob must be YYYY-MM-DD");

  const fid = await familyOf(uid);
  if (!fid) throw new HttpsError("failed-precondition","Join family first");

  const age = computeAge(dob);
  const isAdult = age >= 18;

  const db = admin.firestore();
  await db.collection("families").doc(fid).collection("members").doc(uid).set({
    dob, age, isAdult,
    ageVerifiedByOwner: false,
    geoEnabled: !isAdult 
  }, { merge: true });

  return { ok:true, age, isAdult };
});

export const verifyAgeByOwner = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const ownerUid = req.auth?.uid;
  if (!ownerUid) throw new HttpsError("unauthenticated","Auth required");
  const { targetUid, verified } = req.data as { targetUid: string; verified: boolean };

  const fid = await familyOf(ownerUid);
  if (!fid) throw new HttpsError("failed-precondition","Owner must belong to family");
  const fam = await admin.firestore().collection("families").doc(fid).get();
  if (fam.data()?.ownerUid !== ownerUid) throw new HttpsError("permission-denied","Only owner can verify age");

  const memRef = admin.firestore().collection("families").doc(fid).collection("members").doc(targetUid);
  await memRef.set({ ageVerifiedByOwner: !!verified }, { merge: true });
  return { ok:true };
});

/** 10) Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏ Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› */
export const setGeoPreference = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { enabled } = req.data as { enabled: boolean };

  const fid = await familyOf(uid);
  if (!fid) throw new HttpsError("failed-precondition","Join family first");

  const mem = await admin.firestore().collection("families").doc(fid).collection("members").doc(uid).get();
  const m = mem.data();
  if (!m?.isAdult || !m?.ageVerifiedByOwner) {
    throw new HttpsError("failed-precondition","Only verified adults can change geo");
  }
  await mem.ref.set({ geoEnabled: !!enabled }, { merge: true });
  return { ok:true };
});

/** 11) Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎСџР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В */
export const locationPing = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { lat, lng, acc } = req.data as { lat:number; lng:number; acc?:number };
  if (typeof lat !== "number" || typeof lng !== "number") throw new HttpsError("invalid-argument","lat/lng required");

  const fid = await familyOf(uid);
  if (!fid) throw new HttpsError("failed-precondition","Join family first");

  const db = admin.firestore();
  const memSnap = await db.collection("families").doc(fid).collection("members").doc(uid).get();
  const m = memSnap.data();

  // minors: always allowed; adults: need geoEnabled = true
  if (m?.isAdult && !m?.geoEnabled) throw new HttpsError("failed-precondition","Geo disabled by user");

  const now = admin.firestore.FieldValue.serverTimestamp();
  const tsKey = new Date().toISOString().replace(/[-:TZ.]/g,"").slice(0,14); // yyyyMMddHHmmss

  await db.collection("locations").doc("pings").collection(uid).doc(tsKey).set({
    lat, lng, acc: acc ?? null, at: now
  });
  await db.collection("locations").doc("current").collection("").doc(uid).set({
    lat, lng, at: now
  }, { merge: true });

  return { ok:true };
});

/** 12) Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› (Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В/Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В /Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В ) */
export const setPlace = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { placeId, type, title, center, radiusM } = req.data as {
    placeId: string; type: "home"|"school"|"custom"; title: string;
    center: {lat:number,lng:number}; radiusM: number;
  };

  const fid = await familyOf(uid);
  if (!fid) throw new HttpsError("failed-precondition","Join family first");

  // Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  (Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В )
  const fam = await admin.firestore().collection("families").doc(fid).get();
  const isOwner = fam.data()?.ownerUid === uid;
  const mem = await admin.firestore().collection("families").doc(fid).collection("members").doc(uid).get();
  const isAdult = !!mem.data()?.isAdult;

  if (!isOwner && !isAdult) throw new HttpsError("permission-denied","Only owner/adult can set places");

  await admin.firestore().collection("families").doc(fid).collection("places").doc(placeId).set({
    type, title, center, radiusM
  }, { merge: true });

  return { ok:true };
});

/** 13) Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎвЂќР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В : Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’В/Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦ + Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В */
export const onLocationPing = onDocumentCreated(
  { region: "us-east4", document: "locations/pings/{uid}/{ts}" },
  async (event) => {
    const data = event.data?.data();
    if (!data) return;
    const uid = event.params.uid as string;

    const fid = await familyOf(uid);
    if (!fid) return;

    // Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В 
    const db = admin.firestore();
    const placesSnap = await db.collection("families").doc(fid).collection("places").get();
    if (placesSnap.empty) return;

    const current = { lat: data.lat as number, lng: data.lng as number };

    // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚Сљ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В
    const stateRef = db.collection("families").doc(fid).collection("geoState").doc(uid);
    const prev = (await stateRef.get()).data() || { inside: {} as Record<string, boolean> };
    const inside: Record<string, boolean> = { ...prev.inside };

    for (const p of placesSnap.docs) {
      const placeId = p.id;
      const place = p.data() as any;
      const dist = haversineM(current, place.center);
      const nowInside = dist <= place.radiusM;

      const wasInside = !!inside[placeId];
      if (nowInside !== wasInside) {
        // Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В 
        const type = nowInside ? "enter" : "exit";
        await db.collection("families").doc(fid).collection("geoEvents").add({
          uid, placeId, type, at: admin.firestore.FieldValue.serverTimestamp()
        });

        // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№ Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В/Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™
        const fam = await db.collection("families").doc(fid).get();
        const ownerUid = fam.data()?.ownerUid;
        if (ownerUid) {
          const ownerUser = await db.collection("users").doc(ownerUid).get();
          const tokens: string[] = ownerUser.data()?.fcmTokens ?? [];
          if (tokens.length) {
            await admin.messaging().sendEachForMulticast({
              tokens,
              notification: {
                title: type === "enter" ? "Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎСџР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В " : "Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎСџР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В ",
                body: `${uid} ${type === "enter" ? "Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В " : "Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В "} ${place.title}`
              },
              data: { kind: "geo", uid, placeId, type }
            });
          }
        }
      }
      inside[placeId] = nowInside;
    }

    await stateRef.set({ inside }, { merge: true });
  }
);

/** 14) Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  */
export const getLocationHistory = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { targetUid, fromISO, toISO } = req.data as { targetUid: string; fromISO: string; toISO: string };

  const fid = await familyOf(uid);
  if (!fid) throw new HttpsError("failed-precondition","Join family first");

  // Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚Сњ: Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°; (Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№.) Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№
  const fam = await admin.firestore().collection("families").doc(fid).get();
  const isOwner = fam.data()?.ownerUid === uid;
  if (!isOwner && uid !== targetUid) {
    const me = await admin.firestore().collection("families").doc(fid).collection("members").doc(uid).get();
    if (!me.data()?.isAdult) throw new HttpsError("permission-denied","No access");
  }

  const from = new Date(fromISO); const to = new Date(toISO);
  if (isNaN(from.getTime()) || isNaN(to.getTime())) throw new HttpsError("invalid-argument","bad date range");

  // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В  Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  yyyyMMddHHmmss Р В Р’В Р В РІР‚В Р В Р’В Р Р†Р вЂљРЎв„ў Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В  (Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›: Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  N Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В)
  const pingsRef = admin.firestore().collection("locations").doc("pings").collection(targetUid);
  const snap = await pingsRef.orderBy("at","desc").limit(5000).get();

  const out: any[] = [];
  snap.forEach(d => {
    const v = d.data();
    const at = v.at?.toDate?.() ?? new Date();
    if (at >= from && at <= to) out.push({ lat: v.lat, lng: v.lng, acc: v.acc ?? null, at: at.toISOString() });
  });

  return { ok:true, items: out.reverse() };
});

/** 15) Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В  */
export const cleanupOldPings = onSchedule({ region: "us-east1", schedule: "0 3 * * *" }, async () => {
  const db = admin.firestore();
  const cutoff = Date.now() - 30*86400000;
  const usersSnap = await db.collection("locations").doc("current").collection("").get();
  for (const u of usersSnap.docs) {
    const uid = u.id;
    const pRef = db.collection("locations").doc("pings").collection(uid);
    const last = await pRef.orderBy("at","asc").limit(1000).get();
    const batch = db.batch();
    last.docs.forEach(doc => {
      const at = doc.data()?.at?.toMillis?.() ?? 0;
      if (at < cutoff) batch.delete(doc.ref);
    });
    await batch.commit();
  }
});

/** ===== Owner 80/20 Р В Р’В Р В РІР‚В Р В Р’В Р Р†Р вЂљРЎв„ў helpers ===== */
async function assertFamilyAndMember(uid: string) {
  const db = admin.firestore();
  const uDoc = await db.collection("users").doc(uid).get();
  const familyId = uDoc.data()?.familyId as string | undefined;
  if (!familyId) throw new HttpsError("failed-precondition", "Join family first");
  const mDoc = await db.collection("families").doc(familyId).collection("members").doc(uid).get();
  if (!mDoc.exists) throw new HttpsError("failed-precondition", "Member record not found");
  return { db, familyId, member: mDoc.data()! };
}

async function writeLedger(db: FirebaseFirestore.Firestore, fid: string, actorUid: string, action: string, details: any) {
  await db.collection("families").doc(fid).collection("ledger").add({
    action, actorUid, details, at: admin.firestore.FieldValue.serverTimestamp()
  });
}

/** 1) Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› */
export const proposeOwner = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated", "Auth required");
  const { candidateUid, endsAtISO } = req.data as { candidateUid: string; endsAtISO?: string };

  const { db, familyId } = await assertFamilyAndMember(actor);
  if (!candidateUid) throw new HttpsError("invalid-argument", "candidateUid required");

  const cand = await db.collection("families").doc(familyId).collection("members").doc(candidateUid).get();
  if (!cand.exists) throw new HttpsError("not-found", "Candidate not in family");
  const c = cand.data()!;
  if ((c.age ?? 0) < 14) throw new HttpsError("failed-precondition", "Candidate must be Р В Р’В Р В РІР‚В Р В РЎС›Р РЋРІР‚в„ў 14");

  const eid = db.collection("families").doc(familyId).collection("elections").doc().id;
  const endsAt = endsAtISO ? new Date(endsAtISO) : null;

  await db.collection("families").doc(familyId).collection("elections").doc(eid).set({
    candidateUid, createdBy: actor, status: "open",
    endsAt: endsAt ? admin.firestore.Timestamp.fromDate(endsAt) : null
  });

  // Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›-Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚Сљ Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В  Р В Р’В Р Р†Р вЂљРІвЂћСћР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљРІвЂћСћ
  await db.collection("families").doc(familyId).collection("elections").doc(eid)
    .collection("votes").doc(actor).set({
      choice: true, at: admin.firestore.FieldValue.serverTimestamp()
    });

  await writeLedger(db, familyId, actor, "proposeOwner", { eid, candidateUid });
  return { ok: true, eid };
});

export const finalizeOwner = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated", "Auth required");
  const { eid } = req.data as { eid: string };

  const { db, familyId } = await assertFamilyAndMember(actor);
  const famRef = db.collection("families").doc(familyId);
  const eRef = famRef.collection("elections").doc(eid);
  const eDoc = await eRef.get();
  if (!eDoc.exists) throw new HttpsError("not-found", "Election not found");
  if (eDoc.data()!.status !== "open") throw new HttpsError("failed-precondition", "Already finalized");

  // Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В 
  const votesSnap = await eRef.collection("votes").get();
  let yes = 0, total = 0;
  votesSnap.forEach(v => { total++; if (v.data().choice) yes++; });

  // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В  Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В
  const membersSnap = await famRef.collection("members").get();
  const membersCount = membersSnap.size;
  const pass = yes > membersCount / 2;

  if (pass) {
    // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  (Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›, Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В )
    const candidateUid = eDoc.data()!.candidateUid as string;
    const cand = await famRef.collection("members").doc(candidateUid).get();
    if (!cand.exists || (cand.data()!.age ?? 0) < 14) {
      throw new HttpsError("failed-precondition", "Candidate < 14 (invalid)");
    }
    await famRef.set({ ownerUid: candidateUid }, { merge: true });
  }
  await eRef.set({ status: "finalized" }, { merge: true });
  await writeLedger(db, familyId, actor, "finalizeOwner", { eid, pass, yes, membersCount });

  return { ok: true, pass };
});

/** 4) Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  (Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  owner Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦) */
export const setOwnerManual = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated", "Auth required");
  const { targetUid } = req.data as { targetUid: string };

  const { db, familyId } = await assertFamilyAndMember(actor);
  const fam = (await db.collection("families").doc(familyId).get()).data()!;
  const isOwner = fam.ownerUid === actor;

  // (Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›) Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ў-Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В  ADMINS_UID_CSV
  const ADMINS = (process.env.ADMINS_UID_CSV || "").split(",").map(s => s.trim()).filter(Boolean);
  const isAdmin = ADMINS.includes(actor);

  if (!isOwner && !isAdmin) throw new HttpsError("permission-denied", "Only family owner or admin");

  const cand = await db.collection("families").doc(familyId).collection("members").doc(targetUid).get();
  if (!cand.exists || (cand.data()!.age ?? 0) < 14) {
    throw new HttpsError("failed-precondition", "Target must be Р В Р’В Р В РІР‚В Р В РЎС›Р РЋРІР‚в„ў14 and family member");
  }

  await db.collection("families").doc(familyId).set({ ownerUid: targetUid }, { merge: true });
  await writeLedger(db, familyId, actor, "setOwnerManual", { targetUid });

  return { ok: true };
});

/** 5) Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІвЂћСћР В Р’В Р вЂ™Р’В Р В Р’В Р В РІР‚в„–Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎСџР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В  80/20 (points Р В Р’В Р В РІР‚В  redemptions) */
export const requestFamilyCashout = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated", "Auth required");
  const { totalPoints } = req.data as { totalPoints: number }; // Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ў. 1000000 (Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В )

  if (!totalPoints || totalPoints <= 0) throw new HttpsError("invalid-argument", "totalPoints > 0 required");

  const { db, familyId } = await assertFamilyAndMember(actor);
  const famRef = db.collection("families").doc(familyId);
  const fam = (await famRef.get()).data()!;
  const ownerUid = fam.ownerUid as string;
  if (!ownerUid) throw new HttpsError("failed-precondition", "Owner not set");

  // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљ Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№ Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В 
  const membersSnap = await famRef.collection("members").get();
  const memberUids: string[] = [];
  membersSnap.forEach(d => memberUids.push(d.id));

  const others = memberUids.filter(u => u !== ownerUid);
  const ownerShare = Math.floor(totalPoints * 0.8);
  const othersShareTotal = totalPoints - ownerShare;
  const perOther = others.length > 0 ? Math.floor(othersShareTotal / others.length) : 0;

  // Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В redemptions/{uid}/{rid} Р В Р’В Р В РІР‚В Р В Р’В Р Р†Р вЂљРЎв„ў Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В weeklyPayout Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№
  const batch = db.batch();
  const now = admin.firestore.FieldValue.serverTimestamp();

  const mkRedemption = (toUid: string, pts: number) => {
    const ridRef = db.collection("redemptions").doc(toUid).collection("").doc();
    batch.set(ridRef, { status: "pending", points: pts, toAddress: null, createdAt: now });
  };

  mkRedemption(ownerUid, ownerShare);
  others.forEach(uid => mkRedemption(uid, perOther));

  // Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРІвЂћвЂ“
  const didRef = famRef.collection("distributions").doc();
  batch.set(didRef, {
    initiatedBy: actor,
    totalPoints,
    ownerShare,
    othersShareTotal,
    perMember: Object.fromEntries([
      [ownerUid, ownerShare],
      ...others.map(u => [u, perOther])
    ]),
    at: now
  });

  batch.commit();
  await writeLedger(db, familyId, actor, "cashout", { totalPoints, ownerShare, perOther });

  return { ok: true, ownerUid, ownerShare, perOther, othersCount: others.length };
});

/** 6) Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏ Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В */
export const getDistributionHistory = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated", "Auth required");
  const { limit } = req.data as { limit?: number };
  const { db, familyId } = await assertFamilyAndMember(actor);

  const snap = await db.collection("families").doc(familyId).collection("distributions")
    .orderBy("at", "desc").limit(limit ?? 20).get();

  const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  return { ok: true, items };
});

/** ===== FamilyVault Р В Р’В Р В РІР‚В Р В Р’В Р Р†Р вЂљРЎв„ў helpers & constants ===== */
const CURRENCIES = ["GAD", "BNB", "USDT"] as const;
type Currency = typeof CURRENCIES[number];

function isCurrency(x: any): x is Currency {
  return CURRENCIES.includes(x);
}

async function getFamilyContext(uid: string) {
  const db = admin.firestore();
  const u = await db.collection("users").doc(uid).get();
  const fid = u.data()?.familyId as string | undefined;
  if (!fid) throw new HttpsError("failed-precondition", "Join family first");
  const famRef = db.collection("families").doc(fid);
  const fam = (await famRef.get()).data();
  if (!fam) throw new HttpsError("not-found", "Family not found");
  return { db, fid, famRef, fam };
}

async function ensureVaultDoc(famRef: FirebaseFirestore.DocumentReference<FirebaseFirestore.DocumentData>) {
  const v = await famRef.collection("").doc("vault").get(); // doc id = "vault"
  if (!v.exists) {
    await famRef.collection("").doc("vault").set({
      balances: { GAD: 0, BNB: 0, USDT: 0 },
      frozen:   { GAD: 0, BNB: 0, USDT: 0 },
      policy:   { ownerPct: 80, participantsPct: 20, fundsPct: {} },
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    });
  }
}

async function touchVaultMember(famRef: FirebaseFirestore.DocumentReference, uid: string) {
  const mRef = famRef.collection("vaultMembers").doc(uid);
  const m = await mRef.get();
  if (!m.exists) {
    await mRef.set({
      contributed: { GAD: 0, BNB: 0, USDT: 0 },
      allocated:   { GAD: 0, BNB: 0, USDT: 0 },
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    });
  }
}

async function writeVaultLedger(db: FirebaseFirestore.Firestore, fid: string, actorUid: string, action: string, details: any) {
  await db.collection("families").doc(fid).collection("ledger").add({
    action, actorUid, details, at: admin.firestore.FieldValue.serverTimestamp()
  });
}

/** 1) Р В Р’В Р вЂ™Р’В Р В Р Р‹Р РЋРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№ (Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› owner) */
export const setVaultPolicy = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated","Auth required");
  const { ownerPct, participantsPct, fundsPct } = req.data as {
    ownerPct: number; participantsPct: number;
    fundsPct?: { [k: string]: number }; // Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ў. { reserve: 10, charity: 0 }
  };

  if (ownerPct < 0 || participantsPct < 0) throw new HttpsError("invalid-argument","bad percents");
  const sum = ownerPct + participantsPct + Object.values(fundsPct ?? {}).reduce((a,b)=>a+b,0);
  if (Math.round(sum) !== 100) throw new HttpsError("invalid-argument","Percents must sum to 100");

  const { db, fid, famRef, fam } = await getFamilyContext(actor);
  if (fam.ownerUid !== actor) throw new HttpsError("permission-denied","Only owner can change policy");

  await ensureVaultDoc(famRef);
  await famRef.collection("").doc("vault").set({
    policy: { ownerPct, participantsPct, fundsPct: fundsPct ?? {} },
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  await writeVaultLedger(db, fid, actor, "setVaultPolicy", { ownerPct, participantsPct, fundsPct });
  return { ok: true };
});

export const onVaultIncome = onDocumentCreated(
  { region: "us-east4", document: "families/{fid}/vaultIncomes/{iid}" },
  async (event) => {
    const data = event.data?.data(); if (!data) return;
    const { fid } = event.params as { fid: string };
    const db = admin.firestore();
    const famRef = db.collection("families").doc(fid);

    await ensureVaultDoc(famRef);
    const vDoc = await famRef.collection("").doc("vault").get();
    const policy = vDoc.data()?.policy ?? { ownerPct: 80, participantsPct: 20, fundsPct: {} };

    const currency: Currency = data.currency;
    const total: number = data.amount;
    const fam = (await famRef.get()).data();
    const ownerUid: string = fam?.ownerUid;

    // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№
    const fundsPct = policy.fundsPct ?? {};
    let fundsAlloc: Record<string, number> = {};
    let fundsTotal = 0;
    for (const [k, p] of Object.entries(fundsPct)) {
      const val = Math.floor((total * (p as number)) / 100);
      if (val > 0) { fundsAlloc[k] = val; fundsTotal += val; }
    }

    const remainder = total - fundsTotal;
    const ownerShare = Math.floor((remainder * policy.ownerPct) / 100);
    const participantsShareTotal = remainder - ownerShare;

    // Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№ Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В
    const membersSnap = await famRef.collection("members").get();
    const memberUids: string[] = []; membersSnap.forEach(d => memberUids.push(d.id));
    const others = memberUids.filter(u => u !== ownerUid);
    const perOther = others.length > 0 ? Math.floor(participantsShareTotal / others.length) : 0;

    // Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В  + Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В vaultMembers.allocated
    const batch = db.batch();
    const now = admin.firestore.FieldValue.serverTimestamp();

    const didRef = famRef.collection("vaultDistributions").doc();
    const perMemberEntries = Object.fromEntries([
      [ownerUid, ownerShare],
      ...others.map(u => [u, perOther])
    ]);

    batch.set(didRef, {
      incomeRef: event.data?.ref,
      currency,
      total,
      ownerUid,
      ownerShare,
      participantsShareTotal,
      perMember: perMemberEntries,
      funds: fundsAlloc,
      initiatedBy: "system:auto",
      at: now
    });

    // allocated per member
    const allocInc = (uid: string, amt: number) => {
      const mRef = famRef.collection("vaultMembers").doc(uid);
      batch.set(mRef, {
        allocated: { [currency]: admin.firestore.FieldValue.increment(amt) },
        updatedAt: now
      }, { merge: true });
    };
    allocInc(ownerUid, ownerShare);
    others.forEach(u => allocInc(u, perOther));

    // Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№ vault: balances Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В  Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В addIncome; Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№ Р В Р’В Р В РІР‚В Р В Р’В Р Р†Р вЂљРЎв„ў Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В  frozen
    const vRef = famRef.collection("").doc("vault");
    if (fundsTotal > 0) {
      batch.set(vRef, {
        frozen: { [currency]: admin.firestore.FieldValue.increment(fundsTotal) },
        updatedAt: now
      }, { merge: true });
    }

    await batch.commit();
    await writeVaultLedger(db, fid, "system:auto", "autoDistribute", {
      incomeId: event.params["iid"], currency, total, ownerShare, perOther, fundsAlloc
    });
  }
);

/** 4) Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° / Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В° Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В  (Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС› owner) */
export const freezeFunds = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated","Auth required");
  const { currency, amount, direction } = req.data as { currency: Currency; amount: number; direction: "freeze"|"unfreeze" };
  if (!isCurrency(currency)) throw new HttpsError("invalid-argument","invalid currency");
  if (amount <= 0) throw new HttpsError("invalid-argument","amount > 0 required");

  const { db, fid, famRef, fam } = await getFamilyContext(actor);
  if (fam.ownerUid !== actor) throw new HttpsError("permission-denied","Only owner");

  await ensureVaultDoc(famRef);
  const vRef = famRef.collection("").doc("vault");
  const now = admin.firestore.FieldValue.serverTimestamp();

  if (direction === "freeze") {
    // Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р’В Р В РІР‚В°Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В balances Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р вЂ™Р’В frozen
    await vRef.set({
      balances: { [currency]: admin.firestore.FieldValue.increment(-amount) },
      frozen:   { [currency]: admin.firestore.FieldValue.increment(+amount) },
      updatedAt: now
    }, { merge: true });
  } else {
    await vRef.set({
      balances: { [currency]: admin.firestore.FieldValue.increment(+amount) },
      frozen:   { [currency]: admin.firestore.FieldValue.increment(-amount) },
      updatedAt: now
    }, { merge: true });
  }

  await writeVaultLedger(db, fid, actor, direction, { currency, amount });
  return { ok: true };
});

/** 5) Р В Р’В Р вЂ™Р’В Р В Р’В Р В РІР‚в„–Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р В Р вЂ№Р В Р Р‹Р Р†Р вЂљРЎС™Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚Сљ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№ (Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№, Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В , Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚Сњ-Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В) */
export const getVaultStatus = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated","Auth required");
  const { famRef } = await getFamilyContext(actor);
  await ensureVaultDoc(famRef);

  const v = (await famRef.collection("").doc("vault").get()).data();
  const membersSnap = await famRef.collection("vaultMembers").get();
  const members = membersSnap.docs.map(d => ({ uid: d.id, ...(d.data() as any) }));

  return { ok: true, vault: v, members };
});

/** 6) Р В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎСљР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р В Р вЂ№ (Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р В Р вЂ№Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРЎС›Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№ Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р В Р вЂ№Р В Р’В Р РЋРІР‚СљР В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљРІР‚СњР В Р’В Р В Р вЂ№Р В Р’В Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В РЎС›Р Р†Р вЂљР’ВР В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р вЂ™Р’В Р В Р’В Р Р†Р вЂљР’В¦Р В Р’В Р вЂ™Р’В Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В Р вЂ№Р В Р’В Р В Р РЏ) */
export const getVaultHistory = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const actor = req.auth?.uid; if (!actor) throw new HttpsError("unauthenticated","Auth required");
  const { limit } = req.data as { limit?: number };
  const { famRef } = await getFamilyContext(actor);

  const incSnap = await famRef.collection("vaultIncomes").orderBy("at","desc").limit(limit ?? 50).get();
  const distSnap = await famRef.collection("vaultDistributions").orderBy("at","desc").limit(limit ?? 50).get();

  const incomes = incSnap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));
  const dists   = distSnap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));

  return { ok: true, incomes, distributions: dists };
});


/** ======================= PROMPT 3  NFT / SWAP / LP / STAKING ======================= */

const ALLOW_ONCHAIN_EXECUTION = defineSecret("ALLOW_ONCHAIN_EXECUTION");
const PANCAKE_ROUTER_ADDRESS  = defineSecret("PANCAKE_ROUTER_ADDRESS");
const WBNB_ADDRESS            = defineSecret("WBNB_ADDRESS");
const USDT_ADDRESS            = defineSecret("USDT_ADDRESS");
const GT_ADDRESS              = defineSecret("GT_ADDRESS");
const NFT_MINT_CONTRACT       = defineSecret("NFT_MINT_CONTRACT");
const PRICE_MAP_USD           = defineSecret("PRICE_MAP_USD");

// helpers for age/limit/approval
async function getMember(ctxUid: string) {
  const db = admin.firestore();
  const u = await db.collection("users").doc(ctxUid).get();
  const fid = u.data()?.familyId as string | undefined;
  if (!fid) throw new HttpsError("failed-precondition", "Join family first");
  const mRef = db.collection("families").doc(fid).collection("members").doc(ctxUid);
  const mDoc = await mRef.get();
  return { db, fid, mRef, member: mDoc.data() || {} };
}

function parsePriceMap(jsonOrEmpty?: string) {
  try { return jsonOrEmpty ? JSON.parse(jsonOrEmpty) : {}; }
  catch { return {}; }
}

async function requireApprovalIfMinorOrLimit(
  db: FirebaseFirestore.Firestore,
  fid: string,
  uid: string,
  estUsd: number,
  payload: any,
  type: "NFT"|"SWAP"|"LP"|"STAKE"
) {
  const fam = await db.collection("families").doc(fid).get();
  const ownerUid = fam.data()?.ownerUid as string | undefined;

  const m = await db.collection("families").doc(fid).collection("members").doc(uid).get();
  const age = m.data()?.age ?? 0;

  // Р В Р’В Р СћРІР‚ВР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚СћР В Р’В Р Р†РІР‚С›РІР‚вЂњ Р В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ў Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В 
  const teen = (age >= 14 && age < 18);
  const limit = m.data()?.spendingLimitUSD ?? 0;

  // Р В Р’В Р вЂ™Р’В·Р В Р’В Р вЂ™Р’В° Р В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р В РІР‚В¦Р В Р Р‹Р В Р РЏ Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р РЋРІР‚СњР В Р’В Р РЋРІР‚Сћ Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В¶Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ (Р В Р’В Р РЋРІР‚вЂњР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В±Р В Р’В Р РЋРІР‚Сћ  Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚Сћ ledger)
  const start = new Date(); start.setUTCHours(0,0,0,0);
  const ledgerQ = await db.collection("users").doc(uid)
    .collection("portfolioLedger").where("at", ">=", start).get();
  let spentToday = 0;
  ledgerQ.forEach(d => { if (d.data().kind === "SPENT_USD") spentToday += (d.data().amountUSD || 0); });

  const needApproval =
    (age < 14) ||
    (teen && limit > 0 && (spentToday + estUsd) > limit);

  if (needApproval) {
    const aRef = await db.collection("families").doc(fid).collection("approvals").add({
      type, payload, uid, status: "pending",
      at: admin.firestore.FieldValue.serverTimestamp()
    });
    return { needApproval: true, approvalId: aRef.id, ownerUid };
  }
  return { needApproval: false, approvalId: null, ownerUid };
}

async function pushTo(tokens: string[], title: string, body: string, data: any = {}) {
  if (!tokens?.length) return;
  try {
    await admin.messaging().sendEachForMulticast({ tokens, notification: { title, body }, data });
  } catch {}
}

/** ---------- NFT: requestBuyNft ---------- */
export const requestBuyNft = onCall({ region: US_REGIONS, enforceAppCheck: true, secrets: [PRICE_MAP_USD, ALLOW_ONCHAIN_EXECUTION, NFT_MINT_CONTRACT, BSC_RPC_URL, PAYOUT_PK] }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { collection, tokenURI, priceAmount, priceCurrency } = req.data as {
    collection: string; tokenURI: string; priceAmount: number; priceCurrency: "GAD"|"BNB"|"USDT"|"GT";
  };
  if (!collection || !tokenURI || !priceAmount || !priceCurrency) {
    throw new HttpsError("invalid-argument", "collection/tokenURI/price required");
  }

  const { db, fid } = await getMember(uid);
  const priceMap = parsePriceMap(PRICE_MAP_USD.value());
  const usd = (priceMap[priceCurrency] ?? 0) * priceAmount;

  const appr = await requireApprovalIfMinorOrLimit(
    db, fid, uid, usd,
    { collection, tokenURI, priceAmount, priceCurrency },
    "NFT"
  );

  // Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В·Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р РЋР’В Р В Р’В Р вЂ™Р’В·Р В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В· Р В Р’В Р В РІР‚В  Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РІР‚С™Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р Р†Р вЂљРЎвЂєР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’Вµ (pending/awaiting_approval/approved)
  const orderRef = db.collection("users").doc(uid).collection("portfolioLedger").doc();
  await orderRef.set({
    kind: "NFT_ORDER",
    status: appr.needApproval ? "awaiting_approval" : "approved",
    collection, tokenURI, priceAmount, priceCurrency, amountUSD: usd,
    at: admin.firestore.FieldValue.serverTimestamp()
  });

  // Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚В Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’ВµР В Р’В Р Р†РІР‚С›РІР‚вЂњР В Р’В Р В РІР‚В¦ Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В·Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р Р†РІР‚С™Р’В¬Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р В РІР‚В¦ Р В Р’В Р РЋРІР‚В Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р В РІР‚В¦Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ Р В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ  Р В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚ВР В Р’В Р РЋР’В (Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚вЂќР В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ)
  const allow = (ALLOW_ONCHAIN_EXECUTION.value() || "false").toLowerCase() === "true";
  const mintAddr = NFT_MINT_CONTRACT.value();
  if (allow && mintAddr && !appr.needApproval) {
    const provider = new ethers.JsonRpcProvider(BSC_RPC_URL.value());
    const signer = new ethers.Wallet(PAYOUT_PK.value(), provider);
    const erc721 = new ethers.Contract(mintAddr, ["function safeMint(address to,string uri)"], signer);
    try {
      const tx = await erc721.safeMint(signer.address, tokenURI);
      await tx.wait();
      await db.collection("users").doc(uid).collection("nftOwnerships").doc(tx.hash).set({
        collection, tokenURI, txHash: tx.hash, at: admin.firestore.FieldValue.serverTimestamp()
      });
      await orderRef.set({ status: "filled", txHash: tx.hash }, { merge: true });

      // Р В Р Р‹Р РЋРІР‚СљР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’ВµР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р РЋР’ВР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ
      const uDoc = await db.collection("users").doc(uid).get();
      const tokens: string[] = uDoc.data()?.fcmTokens ?? [];
      await pushTo(tokens, "NFT Р В Р’В Р РЋРІР‚СњР В Р Р‹Р РЋРІР‚СљР В Р’В Р РЋРІР‚вЂќР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦", `Р В Р’В Р РЋРІвЂћСћР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р РЋРІР‚СњР В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ: ${collection}`, { kind: "nft_bought" });
    } catch (e) {
      await orderRef.set({ status: "failed", error: String(e) }, { merge: true });
      throw new HttpsError("internal", "Mint failed");
    }
  }

  return { ok:true, approvalId: appr.approvalId };
});

/** ---------- SWAP: requestSwap (GAD<->BNB/USDT/GT) ---------- */
export const requestSwap = onCall({ region: US_REGIONS, enforceAppCheck: true, secrets: [PRICE_MAP_USD, ALLOW_ONCHAIN_EXECUTION, PANCAKE_ROUTER_ADDRESS, BSC_RPC_URL, PAYOUT_PK, GAD_TOKEN_ADDRESS, USDT_ADDRESS, WBNB_ADDRESS, GT_ADDRESS, TOKEN_DECIMALS] }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { from, to, amount } = req.data as { from: "GAD"|"BNB"|"USDT"|"GT"; to: "GAD"|"BNB"|"USDT"|"GT"; amount: number };
  if (!from || !to || !amount || from === to) throw new HttpsError("invalid-argument","bad params");

  const { db, fid } = await getMember(uid);
  const priceMap = parsePriceMap(PRICE_MAP_USD.value());
  const usd = (priceMap[from] ?? 0) * amount;

  const appr = await requireApprovalIfMinorOrLimit(db, fid, uid, usd, { from, to, amount }, "SWAP");

  // Р В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В·Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р РЋР’В Р В Р’В Р РЋРІР‚СћР В Р Р‹Р В РІР‚С™Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™
  const ordRef = db.collection("users").doc(uid).collection("swapOrders").doc();
  await ordRef.set({
    status: appr.needApproval ? "awaiting_approval" : "approved",
    from, to, amount, amountUSD: usd,
    at: admin.firestore.FieldValue.serverTimestamp()
  });

  // Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’ВµР В Р’В Р Р†РІР‚С›РІР‚вЂњР В Р’В Р В РІР‚В¦ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚Сћ Р В Р’В Р вЂ™Р’В¶Р В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РІР‚в„– (Р В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋР’ВР В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р Р†РІР‚С›РІР‚вЂњ Р В Р’В Р РЋРІР‚вЂќР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚ВР В Р’В Р РЋР’ВР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™, Р В Р’В Р вЂ™Р’В±Р В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В· Р В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»ippage/Р В Р’В Р РЋРІР‚вЂќР В Р Р‹Р РЋРІР‚СљР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р Р†РІР‚С›РІР‚вЂњ  Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р’В Р вЂ™Р’В±Р В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚Сћ Р В Р’В Р В РІР‚В¦Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ Р В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В±Р В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ°)
  const allow = (ALLOW_ONCHAIN_EXECUTION.value() || "false").toLowerCase() === "true";
  if (allow && !appr.needApproval) {
    const provider = new ethers.JsonRpcProvider(BSC_RPC_URL.value());
    const signer = new ethers.Wallet(PAYOUT_PK.value(), provider);
    const router = new ethers.Contract(
      PANCAKE_ROUTER_ADDRESS.value(),
      [
        "function swapExactTokensForTokens(uint amountIn,uint amountOutMin,address[] calldata path,address to,uint deadline) returns (uint[] memory amounts)"
      ],
      signer
    );

    const addr = {
      GAD: GAD_TOKEN_ADDRESS.value(),
      BNB: WBNB_ADDRESS.value(), // Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р вЂ™Р’В·Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В WBNB Р В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚Сњ ERC20
      USDT: USDT_ADDRESS.value(),
      GT: GT_ADDRESS.value(),
    } as Record<string,string>;

    const decimals = Number(TOKEN_DECIMALS.value() || 18);
    const amt = ethers.parseUnits(String(amount), decimals);
    const path = [addr[from], addr[to]];
    try {
      // NOTE: Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В±Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’ВµР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В РЎвЂњР В Р Р‹Р В Р РЏ approve Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В° router Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В° from  Р В Р Р‹Р В Р Р‰Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚Сћ Р В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ Р В Р’В Р В РІР‚В Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚В Р В Р’В Р В РІР‚В  Р В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р РЋРІР‚СљР В Р Р‹Р В РІР‚в„– Р В Р Р‹Р Р†Р вЂљРЎвЂєР В Р Р‹Р РЋРІР‚СљР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚СњР В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РІР‚в„–
      const erc20 = new ethers.Contract(addr[from], ["function approve(address,uint256) returns (bool)"], signer);
      await (await erc20.approve(PANCAKE_ROUTER_ADDRESS.value(), amt)).wait();

      const tx = await router.swapExactTokensForTokens(
        amt,0 as unknown as bigint, path, signer.address,
        BigInt(Math.floor(Date.now()/1000) + 600)
      );
      await tx.wait();

      await ordRef.set({ status: "filled", txHash: tx.hash }, { merge: true });
      await db.collection("users").doc(uid).collection("portfolioLedger").add({
        kind: "SWAP_DONE", from, to, amount, amountUSD: usd,
        at: admin.firestore.FieldValue.serverTimestamp()
      });
    } catch (e) {
      await ordRef.set({ status: "failed", error: String(e) }, { merge: true });
      throw new HttpsError("internal","swap failed");
    }
  }

  return { ok:true, approvalId: appr.approvalId };
});

/** ---------- LP: requestAddLiquidity ---------- */
export const requestAddLiquidity = onCall({ region: US_REGIONS, enforceAppCheck: true, secrets: [PRICE_MAP_USD, ALLOW_ONCHAIN_EXECUTION, PANCAKE_ROUTER_ADDRESS, BSC_RPC_URL, PAYOUT_PK] }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { tokenA, tokenB, amtA, amtB } = req.data as { tokenA:"GAD"|"BNB"|"USDT"|"GT"; tokenB:"GAD"|"BNB"|"USDT"|"GT"; amtA:number; amtB:number };
  if (!tokenA || !tokenB || !amtA || !amtB) throw new HttpsError("invalid-argument","bad params");

  const { db, fid } = await getMember(uid);
  const priceMap = parsePriceMap(PRICE_MAP_USD.value());
  const usd = (priceMap[tokenA] ?? 0) * amtA + (priceMap[tokenB] ?? 0) * amtB;

  const appr = await requireApprovalIfMinorOrLimit(db, fid, uid, usd, { tokenA, tokenB, amtA, amtB }, "LP");

  const ref = db.collection("users").doc(uid).collection("lpOrders").doc();
  await ref.set({
    status: appr.needApproval ? "awaiting_approval" : "approved",
    tokenA, tokenB, amtA, amtB, amountUSD: usd,
    at: admin.firestore.FieldValue.serverTimestamp()
  });

  // (Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р Р†РІР‚С›РІР‚вЂњ addLiquidity Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В· router Р В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ Р В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ swap)
  return { ok:true, approvalId: appr.approvalId };
});

/** ---------- STAKE: requestStake / requestUnstake ---------- */
const DEFAULT_APR_BPS = 800; // 8% Р В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р Р‹Р Р†Р вЂљР’В¦

export const requestStake = onCall({ region: US_REGIONS, enforceAppCheck: true, secrets: [PRICE_MAP_USD] }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { amount, currency, aprBps } = req.data as { amount:number; currency:"GAD"; aprBps?: number };
  if (!amount || currency !== "GAD") throw new HttpsError("invalid-argument","only GAD staking in MVP");

  const { db, fid } = await getMember(uid);
  const priceMap = parsePriceMap(PRICE_MAP_USD.value());
  const usd = (priceMap["GAD"] ?? 0) * amount;

  const appr = await requireApprovalIfMinorOrLimit(db, fid, uid, usd, { amount, currency }, "STAKE");

  const posRef = db.collection("users").doc(uid).collection("stakingPositions").doc();
  await posRef.set({
    status: appr.needApproval ? "awaiting_approval" : "active",
    currency, amount, aprBps: aprBps ?? DEFAULT_APR_BPS,
    accrued: 0,
    since: admin.firestore.FieldValue.serverTimestamp(),
    at: admin.firestore.FieldValue.serverTimestamp()
  });

  return { ok:true, approvalId: appr.approvalId, positionId: posRef.id };
});

export const requestUnstake = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { positionId } = req.data as { positionId: string };
  if (!positionId) throw new HttpsError("invalid-argument","positionId");

  const { db } = await getMember(uid);
  const ref = db.collection("users").doc(uid).collection("stakingPositions").doc(positionId);
  const cur = await ref.get(); if (!cur.exists) throw new HttpsError("not-found","position");
  await ref.set({ status: "closed", closedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });

  await db.collection("users").doc(uid).collection("portfolioLedger").add({
    kind: "UNSTAKE", positionId,
    at: admin.firestore.FieldValue.serverTimestamp()
  });

  return { ok:true };
});

/** ---------- OWNER: approveOperationByOwner ---------- */
export const approveOperationByOwner = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const ownerUid = req.auth?.uid; if (!ownerUid) throw new HttpsError("unauthenticated","Auth required");
  const { approvalId, approve } = req.data as { approvalId: string; approve: boolean };
  const { db, fid } = await getMember(ownerUid);

  const fam = await db.collection("families").doc(fid).get();
  if (fam.data()?.ownerUid !== ownerUid) throw new HttpsError("permission-denied","Only owner");

  const aRef = db.collection("families").doc(fid).collection("approvals").doc(approvalId);
  const a = await aRef.get(); if (!a.exists) throw new HttpsError("not-found","approval");

  await aRef.set({ status: approve ? "approved" : "rejected", decidedAt: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });
  return { ok:true };
});

/** ---------- Trigger: onApprovalUpdated  Р В Р’В Р В РІР‚В Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ°/Р В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° ---------- */
export const onApprovalUpdated = onDocumentCreated(
  { region: "us-east4", document: "families/{fid}/approvals/{aid}" },
  async (event) => {
    // Р В Р’В Р вЂ™Р’ВР В Р Р‹Р В РЎвЂњР В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљР’ВР В Р’В Р РЋР’В Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В° Р В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ Р В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р РЋРІР‚СљР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В° Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В· approveOperationByOwner
    // Р В Р’В Р Р†Р вЂљРІР‚СњР В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РЎвЂњР В Р Р‹Р В Р вЂ° Р В Р’В Р РЋР’ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СњР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В РІР‚в„–Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р В Р вЂ° Р В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚ВР В Р’В Р РЋРІР‚СњР В Р Р‹Р РЋРІР‚Сљ, Р В Р’В Р вЂ™Р’ВµР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р РЋРІР‚В Р В Р’В Р В РІР‚В¦Р В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В¶Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚Сћ Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚Сћ-Р В Р’В Р РЋРІР‚СћР В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В±Р В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ (Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’Вµ Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В°Р В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В).
    return;
  }
);

/** ---------- CRON: Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ APR Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚Сћ Р В Р’В Р В РІР‚В Р В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’ВµР В Р’В Р РЋР’В Р В Р’В Р вЂ™Р’В°Р В Р’В Р РЋРІР‚СњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚ВР В Р’В Р В РІР‚В Р В Р’В Р В РІР‚В¦Р В Р Р‹Р Р†Р вЂљРІвЂћвЂ“Р В Р’В Р РЋР’В Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚ВР В Р Р‹Р Р†Р вЂљР’В Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏР В Р’В Р РЋР’В ---------- */
export const accrueStakingAPR = onSchedule({ region: "us-east1", schedule: "15 3 * * *" }, async () => {
  const db = admin.firestore();
  const users = await db.collection("users").get();
  for (const u of users.docs) {
    const uid = u.id;
    const posSnap = await db.collection("users").doc(uid).collection("stakingPositions")
      .where("status","==","active").get();
    if (posSnap.empty) continue;

    for (const p of posSnap.docs) {
      const d:any = p.data();
      const apr = (d.aprBps ?? DEFAULT_APR_BPS) / 10000; // Р В Р’В Р В РІР‚В  Р В Р’В Р СћРІР‚ВР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏР В Р Р‹Р Р†Р вЂљР’В¦
      // Р В Р’В Р РЋРІР‚вЂќР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚СћР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’В°Р В Р Р‹Р В Р РЏ Р В Р Р‹Р Р†Р вЂљРЎвЂєР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋР’ВР В Р Р‹Р РЋРІР‚СљР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’В° Р В Р Р‹Р В РЎвЂњР В Р Р‹Р РЋРІР‚СљР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚вЂњР В Р’В Р РЋРІР‚Сћ Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ
      const daily = d.amount * (apr / 365);
      const inc = Math.floor(daily * 1e6) / 1e6; // Р В Р’В Р РЋРІР‚СћР В Р’В Р РЋРІР‚СњР В Р Р‹Р В РІР‚С™Р В Р Р‹Р РЋРІР‚СљР В Р’В Р РЋРІР‚вЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦Р В Р’В Р РЋРІР‚ВР В Р’В Р вЂ™Р’Вµ

      await p.ref.set({ accrued: (d.accrued ?? 0) + inc, at: admin.firestore.FieldValue.serverTimestamp() }, { merge: true });

      await db.collection("users").doc(uid).collection("portfolioLedger").add({
        kind: "STAKE_APR", positionId: p.id, amount: inc, currency: "GAD",
        at: admin.firestore.FieldValue.serverTimestamp()
      });

      // Р В Р’В Р РЋРІР‚вЂќР В Р Р‹Р РЋРІР‚СљР В Р Р‹Р Р†РІР‚С™Р’В¬ APR Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦
      const tokens: string[] = u.data()?.fcmTokens ?? [];
      await pushTo(tokens, "APR Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљР Р‹Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р’В Р вЂ™Р’В»Р В Р’В Р вЂ™Р’ВµР В Р’В Р В РІР‚В¦", `+${inc} GAD`, { kind: "apr" });
    }
  }
});

/** ---------- Р В Р’В Р РЋРЎСџР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РІР‚С™Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р Р‹Р Р†Р вЂљРЎвЂєР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°/Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В РЎвЂњР В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р РЋРІР‚СћР В Р Р‹Р В РІР‚С™Р В Р’В Р РЋРІР‚ВР В Р Р‹Р В Р РЏ Р В Р’В Р СћРІР‚ВР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ Р В Р Р‹Р В Р Р‰Р В Р’В Р РЋРІР‚СњР В Р Р‹Р В РІР‚С™Р В Р’В Р вЂ™Р’В°Р В Р’В Р В РІР‚В¦Р В Р’В Р вЂ™Р’В° Р В Р’В Р РЋРІР‚вЂќР В Р’В Р РЋРІР‚СћР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р вЂ°Р В Р’В Р вЂ™Р’В·Р В Р’В Р РЋРІР‚СћР В Р’В Р В РІР‚В Р В Р’В Р вЂ™Р’В°Р В Р Р‹Р Р†Р вЂљРЎв„ўР В Р’В Р вЂ™Р’ВµР В Р’В Р вЂ™Р’В»Р В Р Р‹Р В Р РЏ ---------- */
export const getPortfolio = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const db = admin.firestore();

  const [nftSnap, swapSnap, lpSnap, stakeSnap, ledgerSnap] = await Promise.all([
    db.collection("users").doc(uid).collection("nftOwnerships").orderBy("at","desc").limit(100).get(),
    db.collection("users").doc(uid).collection("swapOrders").orderBy("at","desc").limit(100).get(),
    db.collection("users").doc(uid).collection("lpOrders").orderBy("at","desc").limit(100).get(),
    db.collection("users").doc(uid).collection("stakingPositions").orderBy("at","desc").limit(100).get(),
    db.collection("users").doc(uid).collection("portfolioLedger").orderBy("at","desc").limit(200).get()
  ]);

  const map = (s:any)=>s.docs.map((d:any)=>({id:d.id,...d.data()}));
  return {
    ok:true,
    nfts: map(nftSnap),
    swaps: map(swapSnap),
    lps: map(lpSnap),
    stakes: map(stakeSnap),
    ledger: map(ledgerSnap)
  };
});
/** ======================= /PROMPT 3 ======================= */






/** =================== PERSONAL AI ASSISTANT =================== **/

/** Р В РЎС›Р В РЎвЂР В РЎвЂ”Р РЋРІР‚в„– */
type AssistantTone = "child"|"teen"|"adult";
type AssistantPersona = "coach"|"psychologist"|"friend"|"default";

interface AssistantProfile {
  tone: AssistantTone;
  persona: AssistantPersona;
  remindersEnabled: boolean;
  updatedAt: FirebaseFirestore.FieldValue;
}

/** Р В Р в‚¬Р РЋРІР‚С™Р В РЎвЂР В Р’В»Р В РЎвЂР РЋРІР‚С™Р В Р’В° Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋРІР‚С›Р В РЎвЂР В Р’В»Р РЋР РЏ */
async function getOrInitAssistantProfile(uid: string): Promise<AssistantProfile> {
  const db = admin.firestore();
  const ref = db.collection("users").doc(uid).collection("assistant").doc("profile");
  const snap = await ref.get();
  if (!snap.exists) {
    const def: AssistantProfile = {
      tone: "adult",
      persona: "default",
      remindersEnabled: true,
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    };
    await ref.set(def);
    return def;
  }
  return snap.data() as AssistantProfile;
}

/** 1) Р В Р Р‹Р В РЎвЂўР РЋРІР‚В¦Р РЋР вЂљР В Р’В°Р В Р вЂ¦Р В РЎвЂР РЋРІР‚С™Р РЋР Р‰ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋРІР‚С›Р В РЎвЂР В Р’В»Р РЋР Р‰ Р В Р’В°Р РЋР С“Р РЋР С“Р В РЎвЂР РЋР С“Р РЋРІР‚С™Р В Р’ВµР В Р вЂ¦Р РЋРІР‚С™Р В Р’В° */
export const setAssistantProfile = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { tone, persona, remindersEnabled } = req.data as {
    tone?: AssistantTone; persona?: AssistantPersona; remindersEnabled?: boolean;
  };

  const db = admin.firestore();
  const prof: Partial<AssistantProfile> = {};
  if (tone) prof.tone = tone;
  if (persona) prof.persona = persona;
  if (typeof remindersEnabled === "boolean") prof.remindersEnabled = remindersEnabled;
  prof.updatedAt = admin.firestore.FieldValue.serverTimestamp();

  await db.collection("users").doc(uid).collection("assistant").doc("profile").set(prof, { merge: true });
  return { ok: true };
});

/** 2) Р В РЎСџР РЋР вЂљР В РЎвЂўР РЋРІР‚РЋР В РЎвЂР РЋРІР‚С™Р В Р’В°Р РЋРІР‚С™Р РЋР Р‰ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋРІР‚С›Р В РЎвЂР В Р’В»Р РЋР Р‰ Р В Р’В°Р РЋР С“Р РЋР С“Р В РЎвЂР РЋР С“Р РЋРІР‚С™Р В Р’ВµР В Р вЂ¦Р РЋРІР‚С™Р В Р’В° */
export const getAssistantProfile = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const prof = await getOrInitAssistantProfile(uid);
  return { ok: true, profile: prof };
});

/** 3) Р В РІР‚СњР В РЎвЂР В Р’В°Р В Р’В»Р В РЎвЂўР В РЎвЂ“Р В РЎвЂ Р В Р’В°Р РЋР С“Р РЋР С“Р В РЎвЂР РЋР С“Р РЋРІР‚С™Р В Р’ВµР В Р вЂ¦Р РЋРІР‚С™Р В Р’В° */
export const assistantChat = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { text } = req.data as { text: string };
  if (!text || typeof text !== "string") throw new HttpsError("invalid-argument","text required");

  const db = admin.firestore();
  const prof = await getOrInitAssistantProfile(uid);

  // Р РЋР С“Р В РЎвЂўР РЋРІР‚В¦Р РЋР вЂљР В Р’В°Р В Р вЂ¦Р В РЎвЂР В РЎВ Р РЋР С“Р В РЎвЂўР В РЎвЂўР В Р’В±Р РЋРІР‚В°Р В Р’ВµР В Р вЂ¦Р В РЎвЂР В Р’Вµ Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р РЋР Р‰Р В Р’В·Р В РЎвЂўР В Р вЂ Р В Р’В°Р РЋРІР‚С™Р В Р’ВµР В Р’В»Р РЋР РЏ
  const threadRef = db.collection("messages_private").doc(uid).collection("assistant");
  const mid = threadRef.doc().id;
  await threadRef.doc(mid).set({
    role: "user",
    text,
    profile: { tone: prof.tone, persona: prof.persona },
    createdAt: admin.firestore.FieldValue.serverTimestamp()
  });

  // Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р РЋРЎвЂњР РЋРІР‚РЋР В РЎвЂР В РЎВ Р В РЎвЂўР РЋРІР‚С™Р В Р вЂ Р В Р’ВµР РЋРІР‚С™: Р В Р’ВµР РЋР С“Р В Р’В»Р В РЎвЂ Р В Р’ВµР РЋР С“Р РЋРІР‚С™Р РЋР Р‰ Р В РЎвЂќР В Р’В»Р РЋР вЂ№Р РЋРІР‚РЋ Р Р†Р вЂљРІР‚Сњ Р В РЎВР В РЎвЂўР В Р’В¶Р В Р вЂ¦Р В РЎвЂў Р В РўвЂР В Р’ВµР РЋР вЂљР В Р вЂ¦Р РЋРЎвЂњР РЋРІР‚С™Р РЋР Р‰ Р В Р вЂ Р В Р вЂ¦Р В Р’ВµР РЋРІвЂљВ¬Р В Р вЂ¦Р В РЎвЂР В РІвЂћвЂ“ Р В Р’ВР В Р’В; Р В РўвЂР В Р’В»Р РЋР РЏ MVP Р В РўвЂР В Р’ВµР В Р’В»Р В Р’В°Р В Р’ВµР В РЎВ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂўР В РІвЂћвЂ“ Р В РЎВР В РЎвЂўР В РЎвЂќ
  const apiKey = process.env.AI_API_KEY || "";
  let reply = "";
  if (apiKey) {
    // Р В РІР‚вЂќР В РўвЂР В Р’ВµР РЋР С“Р РЋР Р‰ Р В РЎВР В РЎвЂўР В Р’В¶Р В Р’ВµР РЋРІР‚С™ Р В Р’В±Р РЋРІР‚в„–Р РЋРІР‚С™Р РЋР Р‰ Р В Р вЂ Р РЋРІР‚в„–Р В Р’В·Р В РЎвЂўР В Р вЂ  Р В РЎвЂќ Р В РЎВР В РЎвЂўР В РўвЂР В Р’ВµР В Р’В»Р В РЎвЂ (Vertex/Google AI/OpenAI) Р Р†Р вЂљРІР‚Сњ Р В РЎвЂўР В РЎвЂ”Р РЋРЎвЂњР РЋР С“Р В РЎвЂќР В Р’В°Р В Р’ВµР В РЎВ Р В РўвЂР В Р’ВµР РЋРІР‚С™Р В Р’В°Р В Р’В»Р В РЎвЂ Р РЋР вЂљР В Р’В°Р В РўвЂР В РЎвЂ Р В Р’В±Р В Р’ВµР В Р’В·Р В РЎвЂўР В РЎвЂ”Р В Р’В°Р РЋР С“Р В Р вЂ¦Р В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂ Р В РЎвЂќР В Р’В»Р РЋР вЂ№Р РЋРІР‚РЋР В Р’ВµР В РІвЂћвЂ“.
    // Р В Р Р‹Р В РўвЂР В Р’ВµР В Р’В»Р В Р’В°Р В Р’ВµР В РЎВ Р В Р’В±Р В Р’ВµР В Р’В·Р В РЎвЂўР В РЎвЂ”Р В Р’В°Р РЋР С“Р В Р вЂ¦Р РЋРІР‚в„–Р В РІвЂћвЂ“ Р В РЎвЂ”Р В Р’В»Р В Р’ВµР В РІвЂћвЂ“Р РЋР С“Р РЋРІР‚В¦Р В РЎвЂўР В Р’В»Р В РўвЂР В Р’ВµР РЋР вЂљ Р В РЎвЂўР РЋРІР‚С™Р В Р вЂ Р В Р’ВµР РЋРІР‚С™Р В Р’В° Р В Р вЂ  Р В Р’В·Р В Р’В°Р В Р вЂ Р В РЎвЂР РЋР С“Р В РЎвЂР В РЎВР В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂ Р В РЎвЂўР РЋРІР‚С™ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋРІР‚С›Р В РЎвЂР В Р’В»Р РЋР РЏ.
    reply = (prof.persona === "coach")
      ? "Р В РІР‚СњР В Р’В°Р В Р вЂ Р В Р’В°Р В РІвЂћвЂ“ Р В РЎвЂ”Р В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В Р’В°Р В Р вЂ Р В РЎвЂР В РЎВ Р В РЎВР В Р’В°Р В Р’В»Р В Р’ВµР В Р вЂ¦Р РЋР Р‰Р В РЎвЂќР РЋРЎвЂњР РЋР вЂ№ Р РЋРІР‚В Р В Р’ВµР В Р’В»Р РЋР Р‰ Р В Р вЂ¦Р В Р’В° Р РЋР С“Р В Р’ВµР В РЎвЂ“Р В РЎвЂўР В РўвЂР В Р вЂ¦Р РЋР РЏ Р В РЎвЂ Р РЋР С“Р В РўвЂР В Р’ВµР В Р’В»Р В Р’В°Р В Р’ВµР В РЎВ Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р вЂ Р РЋРІР‚в„–Р В РІвЂћвЂ“ Р РЋРІвЂљВ¬Р В Р’В°Р В РЎвЂ“ ??"
      : (prof.persona === "psychologist")
        ? "Р В Р Р‹Р РЋРІР‚С›Р В РЎвЂўР РЋР вЂљР В РЎВР РЋРЎвЂњР В Р’В»Р В РЎвЂР РЋР вЂљР РЋРЎвЂњР В РІвЂћвЂ“ Р РЋРІР‚РЋР РЋРЎвЂњР В Р вЂ Р РЋР С“Р РЋРІР‚С™Р В Р вЂ Р В РЎвЂў Р В РЎвЂўР В РўвЂР В Р вЂ¦Р В РЎвЂР В РЎВ Р РЋР С“Р В Р’В»Р В РЎвЂўР В Р вЂ Р В РЎвЂўР В РЎВ Р В РЎвЂ Р В РЎвЂўР В РЎвЂ”Р В РЎвЂР РЋРІвЂљВ¬Р В РЎвЂ, Р РЋРІР‚РЋР РЋРІР‚С™Р В РЎвЂў Р В РЎвЂ”Р В РЎвЂўР В РЎВР В РЎвЂўР В РЎвЂ“Р В Р’В»Р В РЎвЂў Р В Р’В±Р РЋРІР‚в„– Р РЋР С“Р В Р вЂ¦Р В РЎвЂР В Р’В·Р В РЎвЂР РЋРІР‚С™Р РЋР Р‰ Р В Р вЂ¦Р В Р’В°Р В РЎвЂ”Р РЋР вЂљР РЋР РЏР В Р’В¶Р В Р’ВµР В Р вЂ¦Р В РЎвЂР В Р’Вµ."
        : "Р В Р вЂЎ Р РЋР вЂљР РЋР РЏР В РўвЂР В РЎвЂўР В РЎВ. Р В РІР‚СњР В Р’В°Р В Р вЂ Р В Р’В°Р В РІвЂћвЂ“ Р РЋР вЂљР В Р’В°Р В Р’В·Р В Р’В±Р В Р’ВµР РЋР вЂљР РЋРІР‚ВР В РЎВР РЋР С“Р РЋР РЏ Р РЋРІвЂљВ¬Р В Р’В°Р В РЎвЂ“ Р В Р’В·Р В Р’В° Р РЋРІвЂљВ¬Р В Р’В°Р В РЎвЂ“Р В РЎвЂўР В РЎВ.";
  } else {
    reply = "?? Р В РЎСџР РЋР вЂљР В РЎвЂР В Р вЂ Р В Р’ВµР РЋРІР‚С™! Р В Р вЂЎ Р РЋРІР‚С™Р В Р вЂ Р В РЎвЂўР В РІвЂћвЂ“ Р В Р’В°Р РЋР С“Р РЋР С“Р В РЎвЂР РЋР С“Р РЋРІР‚С™Р В Р’ВµР В Р вЂ¦Р РЋРІР‚С™. Р В РЎСџР В РЎвЂўР В Р’В·Р В Р’В¶Р В Р’Вµ Р В РЎвЂ”Р В РЎвЂўР В РўвЂР В РЎвЂќР В Р’В»Р РЋР вЂ№Р РЋРІР‚РЋР В РЎвЂР В РЎВ Р Р†Р вЂљРЎС™Р РЋРЎвЂњР В РЎВР В Р вЂ¦Р РЋРІР‚в„–Р В РІвЂћвЂ“Р Р†Р вЂљРЎСљ Р РЋР вЂљР В Р’ВµР В Р’В¶Р В РЎвЂР В РЎВ, Р В Р’В° Р В РЎвЂ”Р В РЎвЂўР В РЎвЂќР В Р’В° Р В РЎвЂ”Р В РЎвЂўР В РЎВР В РЎвЂўР В РЎвЂ“Р РЋРЎвЂњ Р В РЎвЂ”Р В Р’В»Р В Р’В°Р В Р вЂ¦Р В РЎвЂўР В РЎВ Р В Р вЂ¦Р В Р’В° Р В РўвЂР В Р’ВµР В Р вЂ¦Р РЋР Р‰.";
  }

  // Р РЋР С“Р В РЎвЂўР РЋРІР‚В¦Р РЋР вЂљР В Р’В°Р В Р вЂ¦Р В РЎвЂР В РЎВ Р В РЎвЂўР РЋРІР‚С™Р В Р вЂ Р В Р’ВµР РЋРІР‚С™ Р В Р’В°Р РЋР С“Р РЋР С“Р В РЎвЂР РЋР С“Р РЋРІР‚С™Р В Р’ВµР В Р вЂ¦Р РЋРІР‚С™Р В Р’В°
  const rid = threadRef.doc().id;
  await threadRef.doc(rid).set({
    role: "assistant",
    text: reply,
    profile: { tone: prof.tone, persona: prof.persona },
    createdAt: admin.firestore.FieldValue.serverTimestamp()
  });

  // usage score +1
  await db.collection("users").doc(uid).set({
    usageScore: admin.firestore.FieldValue.increment(1),
    usage: { lastMessageAt: admin.firestore.FieldValue.serverTimestamp() }
  }, { merge: true });

  return { ok: true, reply, mid, rid };
});

/** 4) ToDo Р Р†Р вЂљРІР‚Сњ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋР С“Р РЋРІР‚С™Р РЋРІР‚в„–Р В Р’Вµ Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋРІР‚РЋР В РЎвЂ Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р РЋР Р‰Р В Р’В·Р В РЎвЂўР В Р вЂ Р В Р’В°Р РЋРІР‚С™Р В Р’ВµР В Р’В»Р РЋР РЏ */
export const addTodo = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { title, dueISO } = req.data as { title: string; dueISO?: string };
  if (!title) throw new HttpsError("invalid-argument","title required");

  const db = admin.firestore();
  const tid = db.collection("users").doc(uid).collection("todos").doc().id;
  await db.collection("users").doc(uid).collection("todos").doc(tid).set({
    title,
    done: false,
    dueAt: dueISO ? admin.firestore.Timestamp.fromDate(new Date(dueISO)) : null,
    createdAt: admin.firestore.FieldValue.serverTimestamp()
  });

  return { ok: true, tid };
});

export const listTodos = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const snap = await admin.firestore().collection("users").doc(uid).collection("todos").orderBy("createdAt","desc").limit(100).get();
  const items = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));
  return { ok: true, items };
});

export const setTodoDone = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { id, done } = req.data as { id: string; done: boolean };
  if (!id) throw new HttpsError("invalid-argument","id required");
  await admin.firestore().collection("users").doc(uid).collection("todos").doc(id).set({
    done: !!done, doneAt: !!done ? admin.firestore.FieldValue.serverTimestamp() : null
  }, { merge: true });
  return { ok: true };
});

/** 5) Calendar Р Р†Р вЂљРІР‚Сњ Р В Р’В»Р В РЎвЂўР В РЎвЂќР В Р’В°Р В Р’В»Р РЋР Р‰Р В Р вЂ¦Р РЋРІР‚в„–Р В РІвЂћвЂ“ Р В РЎвЂќР В Р’В°Р В Р’В»Р В Р’ВµР В Р вЂ¦Р В РўвЂР В Р’В°Р РЋР вЂљР РЋР Р‰ Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р РЋР Р‰Р В Р’В·Р В РЎвЂўР В Р вЂ Р В Р’В°Р РЋРІР‚С™Р В Р’ВµР В Р’В»Р РЋР РЏ */
export const addCalendarEvent = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { title, startISO, endISO } = req.data as { title: string; startISO: string; endISO?: string };
  if (!title || !startISO) throw new HttpsError("invalid-argument","title/startISO required");

  const db = admin.firestore();
  const eid = db.collection("users").doc(uid).collection("calendar").doc().id;
  await db.collection("users").doc(uid).collection("calendar").doc(eid).set({
    title,
    startAt: admin.firestore.Timestamp.fromDate(new Date(startISO)),
    endAt: endISO ? admin.firestore.Timestamp.fromDate(new Date(endISO)) : null,
    createdAt: admin.firestore.FieldValue.serverTimestamp()
  });
  return { ok: true, eid };
});

export const listCalendarEvents = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const snap = await admin.firestore().collection("users").doc(uid).collection("calendar").orderBy("startAt","asc").limit(100).get();
  const items = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }));
  return { ok: true, items };
});

/** 6) Р В Р’В Р В Р’ВµР В РІвЂћвЂ“Р РЋРІР‚С™Р В РЎвЂР В Р вЂ¦Р В РЎвЂ“ Р В Р’В°Р В РЎвЂќР РЋРІР‚С™Р В РЎвЂР В Р вЂ Р В Р вЂ¦Р В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂ Р В РЎвЂ”Р В РЎвЂў Р РЋР С“Р В Р’ВµР В РЎВР РЋР Р‰Р В Р’Вµ */
export const getFamilyUsageLeaderboard = onCall({ region: US_REGIONS, enforceAppCheck: true }, async (req: any) => {
  const uid = req.auth?.uid; if (!uid) throw new HttpsError("unauthenticated","Auth required");
  const { db, fid } = await getFamilyContext(uid);

  const membersSnap = await db.collection("families").doc(fid).collection("members").get();
  const rows: any[] = [];
  for (const m of membersSnap.docs) {
    const u = await db.collection("users").doc(m.id).get();
    rows.push({ uid: m.id, usageScore: u.data()?.usageScore ?? 0 });
  }
  rows.sort((a,b)=> b.usageScore - a.usageScore);
  return { ok: true, items: rows };
});

/** 7) Р В РЎСљР В Р’В°Р В РЎвЂ“Р РЋР вЂљР В Р’В°Р В РўвЂР РЋРІР‚в„– Р В Р’В·Р В Р’В° Р В РЎвЂР РЋР С“Р В РЎвЂ”Р В РЎвЂўР В Р’В»Р РЋР Р‰Р В Р’В·Р В РЎвЂўР В Р вЂ Р В Р’В°Р В Р вЂ¦Р В РЎвЂР В Р’Вµ (Р РЋРІвЂљВ¬Р В Р’ВµР В РўвЂР РЋРЎвЂњР В Р’В»Р В Р’ВµР РЋР вЂљ, Р В Р’ВµР В Р’В¶Р В Р’ВµР В РўвЂР В Р вЂ¦Р В Р’ВµР В Р вЂ Р В Р вЂ¦Р В РЎвЂў 06:00 UTC) */
export const maybeGrantUsageRewards = onSchedule({ region: "us-east4", schedule: "0 6 * * *" }, async () => {
  const db = admin.firestore();

  // Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР РЋР С“Р РЋРІР‚С™Р В РЎвЂўР В Р’Вµ Р В РЎвЂ”Р РЋР вЂљР В Р’В°Р В Р вЂ Р В РЎвЂР В Р’В»Р В РЎвЂў: Р В Р’В·Р В Р’В° Р В РЎвЂќР В Р’В°Р В Р’В¶Р В РўвЂР РЋРІР‚в„–Р В Р’Вµ 10 Р В Р’В±Р В Р’В°Р В Р’В»Р В Р’В»Р В РЎвЂўР В Р вЂ  Р В Р’В·Р В Р’В° Р В Р вЂ Р РЋРІР‚РЋР В Р’ВµР РЋР вЂљР В Р’В° > +100 GAD (Р В РЎвЂќР В Р’В°Р В РЎвЂќ Р В РЎвЂ”Р В РЎвЂўР В РЎвЂР В Р вЂ¦Р РЋРІР‚С™Р РЋРІР‚в„–/Р В Р’В·Р В Р’В°Р РЋРІР‚РЋР РЋРІР‚ВР РЋРІР‚С™)
  const users = await db.collection("users").limit(2000).get();
  for (const u of users.docs) {
    const usage = u.data()?.usageScore ?? 0;
    if (usage >= 10) {
      // Р В Р’В·Р В Р’В°Р В РЎвЂ”Р В РЎвЂР РЋРІвЂљВ¬Р В Р’ВµР В РЎВ Р В Р вЂ¦Р В Р’В°Р РЋРІР‚РЋР В РЎвЂР РЋР С“Р В Р’В»Р В Р’ВµР В Р вЂ¦Р В РЎвЂР В Р’Вµ Р В Р вЂ  earnings (Р В РЎВР В РЎвЂўР В Р’В¶Р В Р вЂ¦Р В РЎвЂў Р В РЎвЂ”Р В РЎвЂўР РЋРІР‚С™Р В РЎвЂўР В РЎВ Р В РЎвЂќР В РЎвЂўР В Р вЂ¦Р В Р вЂ Р В Р’ВµР РЋР вЂљР РЋРІР‚С™Р В РЎвЂР РЋРІР‚С™Р РЋР Р‰ Р В Р вЂ  redemptions/Р В Р вЂ Р РЋРІР‚в„–Р В РЎвЂ”Р В Р’В»Р В Р’В°Р РЋРІР‚С™Р РЋРІР‚в„–)
      await db.collection("earnings").doc(u.id).collection("").add({
        reason: "assistant_usage_bonus",
        pointsAwarded: 100,
        createdAt: admin.firestore.FieldValue.serverTimestamp()
      });
      // Р РЋР С“Р В Р’В±Р РЋР вЂљР В РЎвЂўР РЋР С“ Р В РЎвЂР В Р’В»Р В РЎвЂ Р РЋР С“Р В Р вЂ¦Р В РЎвЂР В Р’В¶Р В Р’ВµР В Р вЂ¦Р В РЎвЂР В Р’Вµ usageScore (Р В РЎвЂўР В РЎвЂ”Р РЋРІР‚В Р В РЎвЂР В РЎвЂўР В Р вЂ¦Р В Р’В°Р В Р’В»Р РЋР Р‰Р В Р вЂ¦Р В РЎвЂў), Р В Р’В·Р В РўвЂР В Р’ВµР РЋР С“Р РЋР Р‰ Р Р†Р вЂљРІР‚Сњ Р В РЎВР РЋР РЏР В РЎвЂ“Р В РЎвЂќР В РЎвЂў Р РЋРЎвЂњР В РЎВР В Р’ВµР В Р вЂ¦Р РЋР Р‰Р РЋРІвЂљВ¬Р В РЎвЂР В РЎВ
      await db.collection("users").doc(u.id).set({
        usageScore: Math.max(0, usage - 10)
      }, { merge: true });
    }
  }
});

/** 8) Р В РЎСџР РЋР вЂљР В РЎвЂўР В РЎвЂ“Р В Р вЂ¦Р В РЎвЂўР В Р’В· Р В РўвЂР В Р вЂ¦Р РЋР РЏ (Р В РЎвЂ”Р РЋРЎвЂњР РЋРІвЂљВ¬-Р РЋРЎвЂњР В Р вЂ Р В Р’ВµР В РўвЂР В РЎвЂўР В РЎВР В Р’В»Р В Р’ВµР В Р вЂ¦Р В РЎвЂР РЋР РЏ) Р Р†Р вЂљРІР‚Сњ Р В Р вЂ  07:30 UTC */
export const sendDailyForecast = onSchedule({ region: "us-east4", schedule: "30 7 * * *" }, async () => {
  const db = admin.firestore();
  const users = await db.collection("users").limit(2000).get();
  for (const u of users.docs) {
    const uid = u.id;
    const prof = await getOrInitAssistantProfile(uid);

    // Р В Р’В±Р В Р’ВµР РЋР вЂљР РЋРІР‚ВР В РЎВ 3 Р В Р’В±Р В Р’В»Р В РЎвЂР В Р’В¶Р В Р’В°Р В РІвЂћвЂ“Р РЋРІвЂљВ¬Р В РЎвЂР В Р’Вµ Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋРІР‚РЋР В РЎвЂ/Р РЋР С“Р В РЎвЂўР В Р’В±Р РЋРІР‚в„–Р РЋРІР‚С™Р В РЎвЂР РЋР РЏ
    const todosSnap = await db.collection("users").doc(uid).collection("todos").where("done","==",false).orderBy("createdAt","desc").limit(3).get();
    const titles = todosSnap.docs.map(d => (d.data().title as string)).filter(Boolean);

    const tip = (prof.persona === "coach")
      ? "Р В РІР‚в„ўР РЋРІР‚в„–Р В Р’В±Р В Р’ВµР РЋР вЂљР В РЎвЂ Р В РЎвЂўР В РўвЂР В Р вЂ¦Р РЋРЎвЂњ Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋРІР‚РЋР РЋРЎвЂњ Р В РЎвЂ Р РЋР С“Р В РўвЂР В Р’ВµР В Р’В»Р В Р’В°Р В РІвЂћвЂ“ Р В Р’ВµР РЋРІР‚В Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р вЂ Р В РЎвЂўР В РІвЂћвЂ“ Р Р†Р вЂљРІР‚Сњ Р В РЎВР В Р’В°Р В Р’В»Р В Р’ВµР В Р вЂ¦Р РЋР Р‰Р В РЎвЂќР В Р’В°Р РЋР РЏ Р В РЎвЂ”Р В РЎвЂўР В Р’В±Р В Р’ВµР В РўвЂР В Р’В° Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋР С“Р РЋРІР‚С™ Р РЋРІР‚С™Р В РЎвЂўР В Р вЂ¦ Р В РўвЂР В Р вЂ¦Р РЋР вЂ№."
      : (prof.persona === "psychologist")
        ? "Р В Р Р‹Р В РўвЂР В Р’ВµР В Р’В»Р В Р’В°Р В РІвЂћвЂ“ Р В РЎвЂ”Р В Р’В°Р РЋРЎвЂњР В Р’В·Р РЋРЎвЂњ Р В Р вЂ¦Р В Р’В° 3 Р В РЎвЂ“Р В Р’В»Р РЋРЎвЂњР В Р’В±Р В РЎвЂўР В РЎвЂќР В РЎвЂР РЋРІР‚В¦ Р В Р вЂ Р В РўвЂР В РЎвЂўР РЋРІР‚В¦Р В Р’В° Р В РЎвЂ”Р В Р’ВµР РЋР вЂљР В Р’ВµР В РўвЂ Р В Р вЂ¦Р В Р’В°Р РЋРІР‚РЋР В Р’В°Р В Р’В»Р В РЎвЂўР В РЎВ Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋРІР‚РЋ Р Р†Р вЂљРІР‚Сњ Р РЋР РЉР РЋРІР‚С™Р В РЎвЂў Р РЋРЎвЂњР В Р’В»Р РЋРЎвЂњР РЋРІР‚РЋР РЋРІвЂљВ¬Р В Р’В°Р В Р’ВµР РЋРІР‚С™ Р РЋРІР‚С›Р В РЎвЂўР В РЎвЂќР РЋРЎвЂњР РЋР С“."
        : "Р В РЎСљР В Р’В°Р РЋРІР‚РЋР В Р вЂ¦Р В РЎвЂ Р РЋР С“ Р РЋР С“Р В Р’В°Р В РЎВР В РЎвЂўР В РІвЂћвЂ“ Р В РЎвЂќР В РЎвЂўР РЋР вЂљР В РЎвЂўР РЋРІР‚С™Р В РЎвЂќР В РЎвЂўР В РІвЂћвЂ“ Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋРІР‚РЋР В РЎвЂ Р Р†Р вЂљРІР‚Сњ Р В РЎВР В РЎвЂўР В РЎВР В Р’ВµР В Р вЂ¦Р РЋРІР‚С™Р В Р’В°Р В Р’В»Р РЋР Р‰Р В Р вЂ¦Р РЋРІР‚в„–Р В РІвЂћвЂ“ Р В РЎвЂ”Р РЋР вЂљР В РЎвЂўР В РЎвЂ“Р РЋР вЂљР В Р’ВµР РЋР С“Р РЋР С“ Р В РЎВР В РЎвЂўР РЋРІР‚С™Р В РЎвЂР В Р вЂ Р В РЎвЂР РЋР вЂљР РЋРЎвЂњР В Р’ВµР РЋРІР‚С™.";

    const body = titles.length ? ("Р В Р Р‹Р В Р’ВµР В РЎвЂ“Р В РЎвЂўР В РўвЂР В Р вЂ¦Р РЋР РЏ: " + titles.join("; ") + ". " + tip) : ("Р В Р Р‹Р В Р’ВµР В РЎвЂ“Р В РЎвЂўР В РўвЂР В Р вЂ¦Р РЋР РЏ Р В Р’В±Р В Р’ВµР В Р’В· Р В Р’В·Р В Р’В°Р В РўвЂР В Р’В°Р РЋРІР‚РЋ. " + tip);

    // Р В РЎвЂўР РЋРІР‚С™Р В РЎвЂ”Р РЋР вЂљР В Р’В°Р В Р вЂ Р В РЎвЂР В РЎВ Р В РЎвЂ”Р РЋРЎвЂњР РЋРІвЂљВ¬ (Р В Р’ВµР РЋР С“Р В Р’В»Р В РЎвЂ Р В Р’ВµР РЋР С“Р РЋРІР‚С™Р РЋР Р‰ Р РЋРІР‚С™Р В РЎвЂўР В РЎвЂќР В Р’ВµР В Р вЂ¦Р РЋРІР‚в„–)
    const tokens: string[] = u.data()?.fcmTokens ?? u.data()?.expoTokens ?? [];
    if (tokens.length) {
      await admin.messaging().sendEachForMulticast({
        tokens,
        notification: { title: "Р В РЎСџР РЋР вЂљР В РЎвЂўР В РЎвЂ“Р В Р вЂ¦Р В РЎвЂўР В Р’В· Р В РўвЂР В Р вЂ¦Р РЋР РЏ", body },
        data: { kind: "assistant_forecast" }
      });
    }
  }
});
/** ================= END PERSONAL AI ASSISTANT ================= **/

export * from "./assistant";


